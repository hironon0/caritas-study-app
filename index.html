<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カリタス中学校 AI試験対策ツール</title>
    
    <!-- PWA用メタタグ -->
    <meta name="description" content="カリタス中学校の体系数学・Progress 21準拠のAI学習ツール">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="カリタスAI学習">
    
    <!-- 外部ライブラリ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .loading-dots:after {
            content: '...';
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        
        .step-animation {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const StudyTool = () => {
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [currentSection, setCurrentSection] = useState('menu');
            const [isLoading, setIsLoading] = useState(false);
            const [apiStatus, setApiStatus] = useState({ connected: false, checking: true });
            
            // 学習データ
            const [mathProgress, setMathProgress] = useState(() => {
                const saved = localStorage.getItem('caritas_mathProgress');
                return saved ? JSON.parse(saved) : { solved: 0, totalTime: 0 };
            });
            
            const [englishProgress, setEnglishProgress] = useState(() => {
                const saved = localStorage.getItem('caritas_englishProgress');
                return saved ? JSON.parse(saved) : { words: 0, totalTime: 0 };
            });

            const [currentProblem, setCurrentProblem] = useState(null);
            const [currentWord, setCurrentWord] = useState(null);

            // API接続確認
            useEffect(() => {
                const checkApiStatus = async () => {
                    try {
                        const response = await fetch('/api/health');
                        const data = await response.json();
                        setApiStatus({
                            connected: data.ai_available,
                            checking: false,
                            version: data.version,
                            environment: data.environment
                        });
                    } catch (error) {
                        console.error('API接続確認エラー:', error);
                        setApiStatus({ connected: false, checking: false });
                    }
                };
                checkApiStatus();
            }, []);

            // データ自動保存
            useEffect(() => {
                localStorage.setItem('caritas_mathProgress', JSON.stringify(mathProgress));
                localStorage.setItem('caritas_englishProgress', JSON.stringify(englishProgress));
            }, [mathProgress, englishProgress]);

            // AI問題生成関数
            const generateMathProblem = async (grade, unit, level) => {
                setIsLoading(true);

                const prompt = `
カリタス中学校の体系数学に準拠した数学問題を1問作成してください。

設定:
- 学年: ${grade}
- 分野: ${unit === '全分野' ? '該当学年の全分野から選択' : unit}
- 難易度: ${level}

以下の条件を満たしてください:
1. ${grade}レベルに適した問題
2. 思考力を要する良質な問題
3. カリタス中学校の高度なカリキュラムに対応

回答は以下のJSON形式でお願いします:
{
  "grade": "${grade}",
  "level": "${level}",
  "unit": "実際に選択した具体的な単元名",
  "problem": "問題文（数式含む）",
  "steps": [
    {
      "step": "問題理解",
      "content": "問題の要求と与えられた条件を整理",
      "explanation": "何を求められているか、どんな条件があるかを明確化",
      "detail": "より詳しい解説や注意点"
    },
    {
      "step": "解法選択",
      "content": "この問題に最適な解法を選択",
      "explanation": "なぜその解法を選ぶのかの理由",
      "detail": "他の解法との比較や、選択理由の詳細"
    },
    {
      "step": "計算過程",
      "content": "具体的な計算手順",
      "explanation": "各計算の意味と目的",
      "detail": "計算の工夫や注意すべき点"
    },
    {
      "step": "思考の流れ",
      "content": "論理的な思考プロセス",
      "explanation": "どのような思考で解答に到達するか",
      "detail": "つまずきやすいポイントとその対策"
    },
    {
      "step": "検算・確認",
      "content": "答えの正しさを確認する方法",
      "explanation": "なぜ検算が重要かの説明",
      "detail": "具体的な検算手順と確認ポイント"
    },
    {
      "step": "類似問題への応用",
      "content": "この解法が使える他の問題例",
      "explanation": "学習した内容の応用範囲",
      "detail": "発展的な問題や実際の入試での出題例"
    }
  ],
  "answer": "最終的な答案",
  "hint": "困ったときのヒント",
  "difficulty_analysis": "この問題の難しさの分析",
  "learning_point": "この問題で身につく学習内容"
}

DO NOT OUTPUT ANYTHING OTHER THAN VALID JSON.
                `;

                try {
                    const response = await fetch('/api/generate-math', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.error || 'API エラー');
                    }

                    const problemData = JSON.parse(data.result);
                    setCurrentProblem(problemData);
                    
                    // 進捗更新
                    setMathProgress(prev => ({
                        ...prev,
                        solved: prev.solved + 1
                    }));

                    return problemData;

                } catch (error) {
                    console.error('AI問題生成エラー:', error);
                    alert(`問題生成エラー: ${error.message}\n\nしばらく時間をおいて再試行してください。`);
                    return null;
                } finally {
                    setIsLoading(false);
                }
            };

            // 数学学習セクション
            const MathSection = () => {
                const [selectedGrade, setSelectedGrade] = useState('中2');
                const [selectedUnit, setSelectedUnit] = useState('全分野');
                const [selectedLevel, setSelectedLevel] = useState('基礎');
                const [showSteps, setShowSteps] = useState(false);
                const [currentStep, setCurrentStep] = useState(0);

                const gradeOptions = ['中1', '中2', '中3', '高1'];
                const unitsByGrade = {
                    '中1': ['全分野', '正負の数', '文字式', '一次方程式', '比例・反比例'],
                    '中2': ['全分野', '式の計算', '連立方程式', '一次関数', '図形の性質'],
                    '中3': ['全分野', '式の展開・因数分解', '平方根', '二次方程式', '二次関数'],
                    '高1': ['全分野', '数と式', '集合と命題', '二次関数', '図形と計量']
                };
                const levelOptions = [
                    { value: '基礎', description: '基本的な計算・公式の確認' },
                    { value: '標準', description: '定期テスト・教科書レベル' },
                    { value: '応用', description: '思考力・複合問題' },
                    { value: '発展', description: '入試レベル・高度な問題' }
                ];

                if (isLoading) {
                    return (
                        <div className="flex items-center justify-center h-64">
                            <div className="text-center">
                                <div className="text-4xl mb-4 pulse-animation">🤖</div>
                                <div className="text-xl font-bold text-blue-600 mb-2">
                                    AIが高品質な問題を生成中<span className="loading-dots"></span>
                                </div>
                                <div className="text-sm text-gray-600 mb-4">
                                    体系数学に準拠した思考力問題を作成しています
                                </div>
                                <div className="w-64 bg-gray-200 rounded-full h-2 mx-auto">
                                    <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{width: '75%'}}></div>
                                </div>
                            </div>
                        </div>
                    );
                }

                if (!currentProblem) {
                    return (
                        <div className="space-y-6">
                            {/* AI設定パネル */}
                            <div className="bg-white p-6 rounded-lg shadow border">
                                <h4 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    🤖 AI問題生成設定
                                </h4>
                                <div className="grid md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">学年</label>
                                        <select
                                            value={selectedGrade}
                                            onChange={(e) => setSelectedGrade(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                        >
                                            {gradeOptions.map(grade => (
                                                <option key={grade} value={grade}>{grade}</option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">分野</label>
                                        <select
                                            value={selectedUnit}
                                            onChange={(e) => setSelectedUnit(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                        >
                                            {unitsByGrade[selectedGrade].map(unit => (
                                                <option key={unit} value={unit}>{unit}</option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">難易度</label>
                                        <select
                                            value={selectedLevel}
                                            onChange={(e) => setSelectedLevel(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                        >
                                            {levelOptions.map(level => (
                                                <option key={level.value} value={level.value}>
                                                    {level.value} - {level.description}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-2 mb-4">
                                    <div className={`w-3 h-3 rounded-full ${apiStatus.connected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                    <span className="text-sm text-gray-600">
                                        AI状態: {apiStatus.checking ? 'チェック中...' : (apiStatus.connected ? '接続済み' : '接続エラー')}
                                    </span>
                                </div>
                            </div>

                            <div className="text-center bg-gradient-to-r from-blue-50 to-purple-50 p-8 rounded-lg">
                                <div className="text-6xl mb-4">🤖</div>
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">
                                    AI問題生成システム
                                </h3>
                                <p className="text-gray-600 mb-6">
                                    設定: {selectedGrade} | {selectedUnit} | {selectedLevel}レベル
                                </p>
                                <button
                                    onClick={() => generateMathProblem(selectedGrade, selectedUnit, selectedLevel)}
                                    disabled={!apiStatus.connected}
                                    className={`px-8 py-4 rounded-lg text-lg font-medium transition-all transform hover:scale-105 ${
                                        apiStatus.connected 
                                            ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                            : 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                    }`}
                                >
                                    {apiStatus.connected ? '🚀 AI問題生成開始' : '❌ AI接続が必要です'}
                                </button>
                                <p className="text-sm text-gray-500 mt-4">
                                    {apiStatus.connected 
                                        ? '約3-5秒で高品質な問題と詳細解説を生成します'
                                        : 'サーバーのAPIキー設定を確認してください'
                                    }
                                </p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="space-y-6">
                        {/* 問題表示 */}
                        <div className="bg-blue-50 p-6 rounded-lg">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-xl font-bold text-blue-900">
                                    🤖 AI生成問題 - {currentProblem.grade} {currentProblem.unit}
                                </h3>
                                <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                    currentProblem.level === '基礎' ? 'bg-green-200 text-green-800' :
                                    currentProblem.level === '標準' ? 'bg-blue-200 text-blue-800' :
                                    currentProblem.level === '応用' ? 'bg-orange-200 text-orange-800' :
                                    'bg-red-200 text-red-800'
                                }`}>
                                    {currentProblem.level}レベル
                                </span>
                            </div>
                            
                            <div className="bg-white p-6 rounded border-l-4 border-blue-500">
                                <p className="text-lg font-medium mb-4">{currentProblem.problem}</p>
                                {currentProblem.hint && (
                                    <div className="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400">
                                        <p className="text-sm text-yellow-800">
                                            💡 <strong>ヒント:</strong> {currentProblem.hint}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {!showSteps ? (
                            <div className="flex gap-4">
                                <button
                                    onClick={() => setShowSteps(true)}
                                    className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                                >
                                    🧠 AI詳細解説を見る
                                </button>
                                <button
                                    onClick={() => generateMathProblem(selectedGrade, selectedUnit, selectedLevel)}
                                    className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700"
                                >
                                    🔄 新しい問題を生成
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {/* 6段階ステップ解説 */}
                                <div className="bg-gray-50 p-6 rounded-lg">
                                    <h4 className="font-bold text-lg mb-4">🤖 AI生成：6段階詳細解説</h4>
                                    
                                    <div className="flex gap-2 mb-6 flex-wrap">
                                        {currentProblem.steps.map((_, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => setCurrentStep(idx)}
                                                className={`px-4 py-2 rounded text-sm font-medium transition-all ${
                                                    currentStep === idx 
                                                        ? 'bg-blue-600 text-white shadow-md' 
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                {idx + 1}. {currentProblem.steps[idx].step}
                                            </button>
                                        ))}
                                    </div>
                                    
                                    <div className="bg-white p-6 rounded border step-animation">
                                        <h5 className="font-bold text-blue-900 mb-3 text-lg">
                                            {currentStep + 1}. {currentProblem.steps[currentStep].step}
                                        </h5>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <h6 className="font-semibold text-gray-800 mb-2">📝 内容</h6>
                                                <p className="text-gray-800 bg-gray-50 p-3 rounded">
                                                    {currentProblem.steps[currentStep].content}
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h6 className="font-semibold text-gray-800 mb-2">💡 解説</h6>
                                                <p className="text-yellow-800 bg-yellow-50 p-3 rounded">
                                                    {currentProblem.steps[currentStep].explanation}
                                                </p>
                                            </div>
                                            
                                            {currentProblem.steps[currentStep].detail && (
                                                <div>
                                                    <h6 className="font-semibold text-gray-800 mb-2">🔍 詳細</h6>
                                                    <p className="text-blue-800 bg-blue-50 p-3 rounded">
                                                        {currentProblem.steps[currentStep].detail}
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="flex gap-2 mt-6">
                                        <button
                                            onClick={() => setCurrentStep(Math.max(0, currentStep - 1))}
                                            disabled={currentStep === 0}
                                            className="px-4 py-2 bg-gray-500 text-white rounded disabled:opacity-50"
                                        >
                                            ⬅️ 前のステップ
                                        </button>
                                        <button
                                            onClick={() => setCurrentStep(Math.min(currentProblem.steps.length - 1, currentStep + 1))}
                                            disabled={currentStep === currentProblem.steps.length - 1}
                                            className="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50"
                                        >
                                            次のステップ ➡️
                                        </button>
                                    </div>
                                </div>

                                {/* 解答と分析 */}
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="bg-green-50 p-4 rounded-lg">
                                        <h4 className="font-bold text-green-900 mb-2">✅ 解答</h4>
                                        <p className="text-green-800 text-lg font-medium">{currentProblem.answer}</p>
                                    </div>
                                    
                                    {currentProblem.learning_point && (
                                        <div className="bg-purple-50 p-4 rounded-lg">
                                            <h4 className="font-bold text-purple-900 mb-2">📚 学習ポイント</h4>
                                            <p className="text-purple-800 text-sm">{currentProblem.learning_point}</p>
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-4">
                                    <button
                                        onClick={() => {
                                            setShowSteps(false);
                                            setCurrentStep(0);
                                        }}
                                        className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
                                    >
                                        📋 問題に戻る
                                    </button>
                                    <button
                                        onClick={() => generateMathProblem(selectedGrade, selectedUnit, selectedLevel)}
                                        className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                                    >
                                        🔄 新しい問題を生成
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            if (currentSection === 'menu') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 p-4">
                        <div className="max-w-4xl mx-auto">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">🤖</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                    カリタス中学校 AI学習ツール
                                </h1>
                                <h2 className="text-xl font-semibold text-purple-700 mb-2">
                                    完全AI搭載版
                                </h2>
                                <p className="text-gray-600">体系数学・Progress 21準拠 + 本格AI問題生成</p>
                                <div className="mt-4 flex flex-wrap justify-center gap-2 text-sm">
                                    <span className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full">
                                        🤖 Claude AI
                                    </span>
                                    <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                                        📝 詳細解説
                                    </span>
                                    <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full">
                                        🎯 完全準拠
                                    </span>
                                </div>
                            </div>

                            {/* API状態表示 */}
                            <div className="bg-white p-4 rounded-lg shadow mb-6">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <div className={`w-3 h-3 rounded-full ${apiStatus.connected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                        <span className="text-sm font-medium">
                                            AI状態: {apiStatus.checking ? 'チェック中...' : (apiStatus.connected ? '接続済み' : '接続エラー')}
                                        </span>
                                    </div>
                                    {apiStatus.version && (
                                        <span className="text-xs text-gray-500">v{apiStatus.version}</span>
                                    )}
                                </div>
                            </div>

                            <div className="grid gap-6">
                                <div 
                                    onClick={() => {
                                        setSelectedSubject('math');
                                        setCurrentSection('study');
                                    }}
                                    className="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-all cursor-pointer border-l-4 border-blue-500"
                                >
                                    <div className="flex items-center gap-4 mb-4">
                                        <div className="bg-blue-100 p-3 rounded-lg text-3xl">🧮</div>
                                        <div>
                                            <h2 className="text-xl font-bold text-gray-800">数学（完全AI版）</h2>
                                            <p className="text-gray-600">体系数学準拠 + Claude AI問題生成</p>
                                        </div>
                                    </div>
                                    <ul className="text-sm text-gray-700 space-y-1">
                                        <li>• 🤖 <strong>Claude AI問題生成</strong>（思考力重視）</li>
                                        <li>• 📝 <strong>6段階詳細解説</strong>（省略なし）</li>
                                        <li>• 🎯 <strong>学年・分野・難易度</strong>完全対応</li>
                                        <li>• 💡 <strong>ヒント・分析</strong>付きサポート</li>
                                    </ul>
                                    <div className="mt-4 text-sm text-blue-600">
                                        解答済み: {mathProgress.solved} 問題
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow-lg mt-8">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">
                                    🤖 Claude AI機能の特徴
                                </h3>
                                <div className="grid md:grid-cols-3 gap-4 text-sm">
                                    <div className="bg-purple-50 p-4 rounded-lg text-center">
                                        <div className="text-2xl mb-2">🧠</div>
                                        <h4 className="font-bold text-purple-900 mb-1">高度な問題生成</h4>
                                        <p className="text-purple-700">思考力を要する良質な問題</p>
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded-lg text-center">
                                        <div className="text-2xl mb-2">📖</div>
                                        <h4 className="font-bold text-blue-900 mb-1">詳細ステップ解説</h4>
                                        <p className="text-blue-700">理解が深まる段階的説明</p>
                                    </div>
                                    <div className="bg-green-50 p-4 rounded-lg text-center">
                                        <div className="text-2xl mb-2">🎯</div>
                                        <h4 className="font-bold text-green-900 mb-1">完全カスタマイズ</h4>
                                        <p className="text-green-700">個人レベルに最適化</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex items-center gap-4 mb-6">
                            <button
                                onClick={() => setCurrentSection('menu')}
                                className="bg-white p-3 rounded-lg shadow hover:shadow-md transition-all"
                            >
                                ↩️
                            </button>
                            <h1 className="text-2xl font-bold text-gray-800">
                                🤖 AI数学学習
                            </h1>
                            <div className="text-sm text-purple-600 bg-purple-100 px-3 py-1 rounded-full">
                                Claude AI版
                            </div>
                        </div>

                        <MathSection />
                    </div>
                </div>
            );
        };

        ReactDOM.render(<StudyTool />, document.getElementById('root'));
    </script>
</body>
</html>