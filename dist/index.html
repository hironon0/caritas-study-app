<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒªã‚¿ã‚¹ä¸­å­¦æ ¡ AIè©¦é¨“å¯¾ç­–ãƒ„ãƒ¼ãƒ«</title>
    
    <!-- PWAç”¨ãƒ¡ã‚¿ã‚¿ã‚° -->
    <meta name="description" content="ã‚«ãƒªã‚¿ã‚¹ä¸­å­¦æ ¡ã®ä½“ç³»æ•°å­¦ãƒ»Progress 21æº–æ‹ ã®AIå­¦ç¿’ãƒ„ãƒ¼ãƒ«">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ã‚«ãƒªã‚¿ã‚¹AIå­¦ç¿’">
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .loading-dots:after {
            content: '...';
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        
        .step-animation {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const StudyTool = () => {
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [currentSection, setCurrentSection] = useState('menu'); // 'menu', 'math', 'english', 'admin'
            const [isLoading, setIsLoading] = useState(false);
            const [apiStatus, setApiStatus] = useState({ connected: false, checking: true });
            
            // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿
            const [mathProgress, setMathProgress] = useState(() => {
                const saved = localStorage.getItem('caritas_mathProgress');
                return saved ? JSON.parse(saved) : { solved: 0, totalTime: 0 };
            });
            
            const [englishProgress, setEnglishProgress] = useState(() => {
                const saved = localStorage.getItem('caritas_englishProgress');
                return saved ? JSON.parse(saved) : { words: 0, totalTime: 0 };
            });

            const [currentProblem, setCurrentProblem] = useState(null);
            const [currentWord, setCurrentWord] = useState(null);
            const [problemPoolStats, setProblemPoolStats] = useState(null);
            const [usePool, setUsePool] = useState(true); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ—ãƒ¼ãƒ«ä½¿ç”¨
            
            // MathSectionç”¨ã®çŠ¶æ…‹ã‚’è¦ªãƒ¬ãƒ™ãƒ«ã§ç®¡ç†
            const [mathStudyMode, setMathStudyMode] = useState('setup');
            const [mathStudySettings, setMathStudySettings] = useState(null);
            const [mathCurrentProblem, setMathCurrentProblem] = useState(null);
            const [mathIsLoading, setMathIsLoading] = useState(false);
            
            // ç®¡ç†ç”»é¢ç”¨ã®çŠ¶æ…‹
            const [adminMode, setAdminMode] = useState(false);
            const [generatedProblems, setGeneratedProblems] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç”¨ã®çŠ¶æ…‹
            const [showConfirmDialog, setShowConfirmDialog] = useState(false);
            const [confirmConfig, setConfirmConfig] = useState({
                title: '',
                message: '',
                onConfirm: null,
                onCancel: null
            });

            // APIæ¥ç¶šç¢ºèª
            useEffect(() => {
                // è¤‡æ•°ãƒãƒ¼ãƒˆã‚’è©¦è¡Œã—ã¦APIæ¥ç¶šã‚’ç¢ºç«‹
                const tryPorts = [3001, 3002, 3000];
                let API_URL = null;

                const checkApiStatus = async () => {
                    let lastError = null;
                    
                    // å„ãƒãƒ¼ãƒˆã‚’é †ç•ªã«è©¦è¡Œ
                    for (const port of tryPorts) {
                        const testUrl = `http://localhost:${port}`;
                        try {
                            console.log(`APIæ¥ç¶šãƒ†ã‚¹ãƒˆ: ${testUrl}/api/health`);
                            const response = await fetch(`${testUrl}/api/health`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                mode: 'cors',
                                credentials: 'omit', // Safari/Braveå¯¾å¿œ
                                signal: AbortSignal.timeout(5000) // 5ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            
                            // æ¥ç¶šæˆåŠŸ
                            API_URL = testUrl;
                            window.CARITAS_API_URL = API_URL;
                            
                            setApiStatus({
                                connected: data.openai_available,
                                checking: false,
                                version: data.version,
                                environment: data.environment,
                                apiUrl: API_URL,
                                port: port
                            });
                            
                            console.log(`âœ… APIæ¥ç¶šæˆåŠŸ: ${API_URL}`);
                            return; // æˆåŠŸã—ãŸã‚‰çµ‚äº†
                            
                        } catch (error) {
                            console.log(`âŒ ãƒãƒ¼ãƒˆ${port}æ¥ç¶šå¤±æ•—:`, error.message);
                            lastError = error;
                            continue; // æ¬¡ã®ãƒãƒ¼ãƒˆã‚’è©¦è¡Œ
                        }
                    }
                    
                    // ã™ã¹ã¦ã®ãƒãƒ¼ãƒˆã§å¤±æ•—
                    console.error('ã™ã¹ã¦ã®ãƒãƒ¼ãƒˆã§æ¥ç¶šå¤±æ•—:', lastError);
                    
                    // ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤å®šã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    const userAgent = navigator.userAgent;
                    const isSafari = userAgent.includes('Safari') && !userAgent.includes('Chrome');
                    const isBrave = userAgent.includes('Brave') || userAgent.includes('Chromium');
                    
                    let errorMessage = `APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${lastError?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
                    
                    if (isSafari) {
                        errorMessage += '\n\nğŸ¦ Safariä½¿ç”¨æ™‚ã®è§£æ±ºæ–¹æ³•:\n1. Safari > é–‹ç™º > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã‚’ç„¡åŠ¹ã«ã™ã‚‹\n2. Safari > é–‹ç™º > Cross-Originåˆ¶é™ã‚’ç„¡åŠ¹ã«ã™ã‚‹\n3. Chrome/Firefoxã®ä½¿ç”¨ã‚’æ¨å¥¨';
                    } else if (isBrave) {
                        errorMessage += '\n\nğŸ›¡ï¸ Braveä½¿ç”¨æ™‚ã®è§£æ±ºæ–¹æ³•:\n1. Braveè¨­å®š > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ > ã‚·ãƒ¼ãƒ«ãƒ‰ã‚’ä¸‹ã’ã‚‹\n2. ã“ã®ã‚µã‚¤ãƒˆã§åºƒå‘Šãƒ»ãƒˆãƒ©ãƒƒã‚«ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç„¡åŠ¹ã«ã™ã‚‹\n3. Chrome/Firefoxã®ä½¿ç”¨ã‚’æ¨å¥¨';
                    }
                    
                    setApiStatus({ 
                        connected: false, 
                        checking: false, 
                        error: errorMessage,
                        testedPorts: tryPorts
                    });
                };
                
                checkApiStatus();
            }, []);

            // å•é¡Œãƒ—ãƒ¼ãƒ«çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ï¼ˆç‹¬ç«‹é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼‰
            const fetchProblemPoolStats = async () => {
                if (!window.CARITAS_API_URL) return;
                
                try {
                    const response = await fetch(`${window.CARITAS_API_URL}/api/problem-pool/stats`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        setProblemPoolStats(data.stats);
                        console.log('ğŸ“Š å•é¡Œãƒ—ãƒ¼ãƒ«çµ±è¨ˆæƒ…å ±å–å¾—æˆåŠŸ:', data.stats);
                        return data.stats;
                    } else {
                        console.log('ğŸ“Š çµ±è¨ˆæƒ…å ±å–å¾—å¤±æ•—: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', response.status);
                        return null;
                    }
                } catch (error) {
                    console.log('ğŸ“Š å•é¡Œãƒ—ãƒ¼ãƒ«çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error.message);
                    return null;
                }
            };

            // åˆæœŸçµ±è¨ˆæƒ…å ±å–å¾—
            useEffect(() => {
                if (apiStatus.connected) {
                    fetchProblemPoolStats();
                }
            }, [apiStatus.connected]);

            // å•é¡Œã‚’ãƒ—ãƒ¼ãƒ«ã«è¿½åŠ ã™ã‚‹é–¢æ•°
            const addProblemToPool = async (problem) => {
                try {
                    const API_URL = window.CARITAS_API_URL;
                    console.log('ğŸ“ å•é¡Œã‚’ãƒ—ãƒ¼ãƒ«ã«è¿½åŠ ä¸­:', problem.id || 'IDæœªè¨­å®š');
                    
                    const response = await fetch(`${API_URL}/api/problem-pool/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ problem }),
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log('âœ… å•é¡Œãƒ—ãƒ¼ãƒ«è¿½åŠ æˆåŠŸ:', data.problem_id);
                        
                        // çµ±è¨ˆæƒ…å ±ã‚’å†å–å¾—
                        await fetchProblemPoolStats();
                        
                        return true;
                    }
                    
                    throw new Error('å•é¡Œã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    
                } catch (error) {
                    console.error('å•é¡Œãƒ—ãƒ¼ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('å•é¡Œè¿½åŠ ã‚¨ãƒ©ãƒ¼', `å•é¡Œã‚’ãƒ—ãƒ¼ãƒ«ã«è¿½åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.message}\n\nã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    return false;
                }
            };

            // ç®¡ç†ç”¨å•é¡Œç”Ÿæˆé–¢æ•°ï¼ˆå˜ä¸€å•é¡Œï¼‰
            const generateProblemForPool = async (subject, grade, unit, level) => {
                setIsGenerating(true);
                
                try {
                    let problem = null;
                    
                    if (subject === 'math') {
                        problem = await generateMathProblem(grade, unit, level);
                    } else if (subject === 'english') {
                        // è‹±èªå•é¡Œç”Ÿæˆï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
                        problem = await generateEnglishWord(grade, level);
                    }
                    
                    if (problem) {
                        // ãƒ—ãƒ¼ãƒ«è¿½åŠ ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                        problem.source = 'generated_for_pool';
                        problem.created_for_pool = true;
                        
                        // ç”Ÿæˆã•ã‚ŒãŸå•é¡Œãƒªã‚¹ãƒˆã«è¿½åŠ 
                        setGeneratedProblems(prev => [problem, ...prev]);
                        
                        return problem;
                    }
                    
                } catch (error) {
                    console.error('ç®¡ç†ç”¨å•é¡Œç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('å•é¡Œç”Ÿæˆã‚¨ãƒ©ãƒ¼', `AIå•é¡Œç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.message}\n\nAPIæ¥ç¶šçŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                } finally {
                    setIsGenerating(false);
                }
                
                return null;
            };

            // ç®¡ç†ç”»é¢ç”¨ä¸€æ‹¬å•é¡Œç”Ÿæˆé–¢æ•°
            const generateBatchProblemsForPool = async (subject, grade, unit, level, count) => {
                if (subject !== 'math') {
                    console.log('ç¾åœ¨ã¯æ•°å­¦ã®ã¿å¯¾å¿œ');
                    return;
                }

                setIsGenerating(true);
                try {
                    console.log(`ğŸš€ ${count}å•ã®ä¸€æ‹¬ç”Ÿæˆé–‹å§‹`);
                    
                    const API_URL = window.CARITAS_API_URL;
                    const response = await fetch(`${API_URL}/api/generate-math-batch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            grade,
                            unit,
                            level,
                            count
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'ä¸€æ‹¬ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
                    const batchResult = JSON.parse(data.result);
                    if (!batchResult.problems || !Array.isArray(batchResult.problems)) {
                        throw new Error('ä¸€æ‹¬ç”Ÿæˆã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™');
                    }

                    console.log(`âœ… ${batchResult.problems.length}å•ã®ä¸€æ‹¬ç”ŸæˆæˆåŠŸ`);

                    // ç”Ÿæˆã•ã‚ŒãŸå•é¡Œã‚’å…¨ã¦è¿½åŠ 
                    const newProblems = batchResult.problems.map(problem => ({
                        ...problem,
                        addedToPool: false,
                        source: 'generated_for_pool_batch',
                        created_for_pool: true,
                        timestamp: new Date().toISOString(),
                        id: `batch_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                    }));

                    setGeneratedProblems(prev => [...newProblems, ...prev]);
                    
                    console.log(`ğŸ“ ${newProblems.length}å•ã‚’ç”Ÿæˆå•é¡Œãƒªã‚¹ãƒˆã«è¿½åŠ å®Œäº†`);

                } catch (error) {
                    console.error('ç®¡ç†ç”¨ä¸€æ‹¬å•é¡Œç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('ä¸€æ‹¬å•é¡Œç”Ÿæˆã‚¨ãƒ©ãƒ¼', `AIä¸€æ‹¬å•é¡Œç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.message}\n\nAPIæ¥ç¶šçŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                } finally {
                    setIsGenerating(false);
                }
            };

            // ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ä¿å­˜
            useEffect(() => {
                localStorage.setItem('caritas_mathProgress', JSON.stringify(mathProgress));
                localStorage.setItem('caritas_englishProgress', JSON.stringify(englishProgress));
            }, [mathProgress, englishProgress]);

            // å•é¡Œãƒ—ãƒ¼ãƒ«ã‹ã‚‰å•é¡Œå–å¾—é–¢æ•°
            const getProblemFromPool = async (grade, unit, level) => {
                setIsLoading(true);
                
                try {
                    const API_URL = window.CARITAS_API_URL;
                    console.log(`ğŸ“š å•é¡Œãƒ—ãƒ¼ãƒ«å–å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${grade}/${unit}/${level}`);
                    
                    const response = await fetch(`${API_URL}/api/problem-pool/${encodeURIComponent(grade)}/${encodeURIComponent(unit)}/${encodeURIComponent(level)}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            const errorData = await response.json();
                            console.log('ğŸ“š ãƒ—ãƒ¼ãƒ«ã«å•é¡Œãªã—:', errorData.message);
                            showAlert('å•é¡Œãƒ—ãƒ¼ãƒ«ãŒç©ºã§ã™', `æŒ‡å®šã•ã‚ŒãŸæ¡ä»¶ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nè©³ç´°: ${errorData.message}\n\nç®¡ç†ç”»é¢ã§AIå•é¡Œã‚’ç”Ÿæˆã—ã¦ãƒ—ãƒ¼ãƒ«ã«è¿½åŠ ã™ã‚‹ã‹ã€\nAIç”Ÿæˆæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚`);
                            return null;
                        }
                        throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success && data.problem) {
                        console.log('âœ… å•é¡Œãƒ—ãƒ¼ãƒ«ã‹ã‚‰å–å¾—æˆåŠŸ:', data.problem.id);
                        return data.problem;
                    }
                    
                    throw new Error('ãƒ—ãƒ¼ãƒ«ã‹ã‚‰å•é¡Œã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    
                } catch (error) {
                    console.error('å•é¡Œãƒ—ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('å•é¡Œãƒ—ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼', `å•é¡Œãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.message}\n\nã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã‹ã€AIç”Ÿæˆæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚`);
                    return null;
                } finally {
                    setIsLoading(false);
                }
            };

            // AIå•é¡Œç”Ÿæˆé–¢æ•°ï¼ˆè©³ç´°è§£èª¬ç‰ˆï¼‰
            const generateMathProblem = async (grade, unit, level) => {
                setIsLoading(true);

                const prompt = `
ã‚«ãƒªã‚¿ã‚¹ä¸­å­¦æ ¡ã®ä½“ç³»æ•°å­¦ã«æº–æ‹ ã—ãŸæ•°å­¦å•é¡Œã‚’1å•ä½œæˆã—ã¦ãã ã•ã„ã€‚

è¨­å®š:
- å­¦å¹´: ${grade}
- åˆ†é‡: ${unit === 'å…¨åˆ†é‡' ? 'è©²å½“å­¦å¹´ã®å…¨åˆ†é‡ã‹ã‚‰é¸æŠ' : unit}
- é›£æ˜“åº¦: ${level}

ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ãã ã•ã„:
1. ${grade}ãƒ¬ãƒ™ãƒ«ã«é©ã—ãŸå•é¡Œ
2. æ€è€ƒåŠ›ã‚’è¦ã™ã‚‹è‰¯è³ªãªå•é¡Œ
3. ã‚«ãƒªã‚¿ã‚¹ä¸­å­¦æ ¡ã®é«˜åº¦ãªã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã«å¯¾å¿œ

**è§£èª¬ã¯çµ¶å¯¾ã«çœç•¥ã›ãšã€ä¸­å­¦ç”ŸãŒç†è§£ã§ãã‚‹ã‚ˆã†ä¸€ã¤ä¸€ã¤ã®æ‰‹é †ã‚’ä¸å¯§ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚**

å›ç­”ã¯ä»¥ä¸‹ã®JSONå½¢å¼ã§ãŠé¡˜ã„ã—ã¾ã™:
{
  "grade": "${grade}",
  "level": "${level}",
  "unit": "å®Ÿéš›ã«é¸æŠã—ãŸå…·ä½“çš„ãªå˜å…ƒå",
  "problem": "å•é¡Œæ–‡ï¼ˆæ•°å¼å«ã‚€ï¼‰",
  "steps": [
    {
      "step": "å•é¡Œç†è§£ãƒ»æ¡ä»¶æ•´ç†",
      "content": "å•é¡Œæ–‡ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æƒ…å ±ã‚’å…¨ã¦æ•´ç†ã—ã€æ±‚ã‚ã‚‹ã‚‚ã®ã‚’æ˜ç¢ºã«ã™ã‚‹",
      "explanation": "ãªãœã“ã®æƒ…å ±ãŒé‡è¦ãªã®ã‹ã€ã©ã®ã‚ˆã†ã«å•é¡Œã‚’è§£é‡ˆã™ã‚‹ã‹ã‚’è©³ã—ãèª¬æ˜",
      "detail": "è¦‹è½ã¨ã—ãŒã¡ãªãƒã‚¤ãƒ³ãƒˆã‚„ã€å•é¡Œæ–‡ã®èª­ã¿æ–¹ã®ã‚³ãƒ„"
    },
    {
      "step": "è§£æ³•ã®é¸æŠã¨æ–¹é‡æ±ºå®š",
      "content": "è¤‡æ•°ã®è§£æ³•ã‹ã‚‰æœ€é©ãªã‚‚ã®ã‚’é¸æŠã—ã€ãªãœãã®æ–¹æ³•ãŒè‰¯ã„ã‹ã‚’åˆ¤æ–­ã™ã‚‹",
      "explanation": "è§£æ³•é¸æŠã®æ ¹æ‹ ã‚’è«–ç†çš„ã«èª¬æ˜ã—ã€ä»–ã®æ–¹æ³•ã¨ã®æ¯”è¼ƒã‚‚è¡Œã†",
      "detail": "åˆå­¦è€…ãŒè¿·ã„ãŒã¡ãªè§£æ³•é¸æŠã®ãƒã‚¤ãƒ³ãƒˆã¨ã€åŠ¹ç‡çš„ãªè§£ãæ–¹ã®ç†ç”±"
    },
    {
      "step": "å¼ã®å¤‰å½¢ãƒ»è¨ˆç®—ã®æº–å‚™",
      "content": "è§£æ³•ã«å¿…è¦ãªå…¬å¼ã‚„å®šç†ã‚’ç¢ºèªã—ã€è¨ˆç®—ã®æº–å‚™ã‚’æ•´ãˆã‚‹",
      "explanation": "ä½¿ç”¨ã™ã‚‹å…¬å¼ãŒãªãœé©ç”¨ã§ãã‚‹ã®ã‹ã€æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèª",
      "detail": "å…¬å¼ã‚’è¦šãˆã‚‹ã‚³ãƒ„ã‚„ã€æ¡ä»¶ç¢ºèªã®é‡è¦æ€§ã«ã¤ã„ã¦"
    },
    {
      "step": "è¨ˆç®—éç¨‹ï¼ˆè©³ç´°ã‚¹ãƒ†ãƒƒãƒ—ï¼‰",
      "content": "ä¸€è¡Œä¸€è¡Œã®è¨ˆç®—ã‚’çœç•¥ã›ãšã€ã™ã¹ã¦ã®å¤‰å½¢éç¨‹ã‚’ä¸å¯§ã«ç¤ºã™",
      "explanation": "å„å¤‰å½¢ã®ç†ç”±ã¨ã€ãªãœãã®è¨ˆç®—ãŒå¿…è¦ãªã®ã‹ã‚’è©³ã—ãèª¬æ˜",
      "detail": "è¨ˆç®—ãƒŸã‚¹ã‚’é˜²ãã‚³ãƒ„ã€è¨ˆç®—ã®å·¥å¤«ã€ç¬¦å·ã‚„åˆ†æ•°ã®æ‰±ã„æ–¹"
    },
    {
      "step": "è«–ç†çš„æ€è€ƒã¨æ¨è«–",
      "content": "è¨ˆç®—çµæœã‹ã‚‰çµè«–ã‚’å°ãè«–ç†çš„ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ˜ç¢ºã«ç¤ºã™",
      "explanation": "ãªãœãã®çµè«–ãŒæ­£ã—ã„ã¨è¨€ãˆã‚‹ã®ã‹ã€æ¨è«–ã®æ ¹æ‹ ã‚’èª¬æ˜",
      "detail": "æ•°å­¦çš„æ¨è«–ã®é€²ã‚æ–¹ã€è¨¼æ˜çš„ãªè€ƒãˆæ–¹ã®ãƒã‚¤ãƒ³ãƒˆ"
    },
    {
      "step": "æ¤œç®—ã¨è§£ã®å¦¥å½“æ€§ç¢ºèª",
      "content": "è¤‡æ•°ã®æ–¹æ³•ã§ç­”ãˆã‚’ç¢ºèªã—ã€è§£ãŒå•é¡Œã®æ¡ä»¶ã‚’æº€ãŸã™ã‹ãƒã‚§ãƒƒã‚¯",
      "explanation": "æ¤œç®—ã®å…·ä½“çš„æ‰‹é †ã¨ã€è§£ã®æ„å‘³ãŒç¾å®Ÿçš„ã‹ã©ã†ã‹ã®ç¢ºèªæ–¹æ³•",
      "detail": "è¦‹è½ã¨ã—ãŒã¡ãªæ¤œç®—ãƒã‚¤ãƒ³ãƒˆã€è§£ã®ç¯„å›²ã‚„å˜ä½ã®ç¢ºèª"
    },
    {
      "step": "ã¾ã¨ã‚ã¨å¿œç”¨ãƒ»ç™ºå±•",
      "content": "è§£ç­”ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã®ã¾ã¨ã‚ã¨ã€é¡ä¼¼å•é¡Œã¸ã®å¿œç”¨æ–¹æ³•",
      "explanation": "ã“ã®å•é¡Œã§å­¦ã‚“ã ã“ã¨ã®æœ¬è³ªã¨ã€ä»–ã®å•é¡Œã§ã‚‚ä½¿ãˆã‚‹è€ƒãˆæ–¹",
      "detail": "ç™ºå±•çš„ãªå•é¡Œä¾‹ã€å…¥è©¦ã§ã‚ˆãå‡ºã‚‹é¡ä¼¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã€è¦šãˆã¦ãŠãã¹ããƒã‚¤ãƒ³ãƒˆ"
    }
  ],
  "answer": "æœ€çµ‚çš„ãªç­”æ¡ˆ",
  "hint": "å›°ã£ãŸã¨ãã®ãƒ’ãƒ³ãƒˆ",
  "difficulty_analysis": "ã“ã®å•é¡Œã®é›£ã—ã•ã®åˆ†æ",
  "learning_point": "ã“ã®å•é¡Œã§èº«ã«ã¤ãå­¦ç¿’å†…å®¹"
}

DO NOT OUTPUT ANYTHING OTHER THAN VALID JSON.
                `;

                const API_URL = window.CARITAS_API_URL;

                try {
                    console.log(`å•é¡Œç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${API_URL}/api/generate-math`);
                    
                    const response = await fetch(`${API_URL}/api/generate-math`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ prompt }),
                        mode: 'cors',
                        credentials: 'omit' // Safariå¯¾å¿œ
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ‰åŠ¹ãªJSONå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“' }));
                        const error = new Error(errorData.error || `HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        error.response = response;
                        throw error;
                    }

                    const data = await response.json();

                    if (!data.success) {
                        const error = new Error(data.error || 'API ã‚¨ãƒ©ãƒ¼');
                        error.response = response;
                        throw error;
                    }

                    const problemData = JSON.parse(data.result);
                    return problemData;

                } catch (error) {
                    console.error('AIå•é¡Œç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    let errorMessage = error.message;
                    
                    // Safariç‰¹æœ‰ã®ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
                    const isSafari = navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome');
                    if (isSafari && (error.message.includes('Load failed') || error.message.includes('NetworkError'))) {
                        errorMessage = `Safariæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nè§£æ±ºæ–¹æ³•:\n1. Safari > é–‹ç™º > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚’ç„¡åŠ¹ã«ã™ã‚‹\n2. Chromeã€Firefoxã€Edgeãªã©ã®ä»–ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„\n3. HTTPæ¥ç¶šãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„`;
                    }
                    
                    if (error.response) {
                        try {
                            const errorData = await error.response.json();
                            console.error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼è©³ç´°:', errorData);
                            if (!isSafari) { // Safariä»¥å¤–ã§ã¯è©³ç´°ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                                errorMessage += `\n\nã‚µãƒ¼ãƒãƒ¼è©³ç´°: ${errorData.details || JSON.stringify(errorData)}`;
                            }
                        } catch (e) {
                            console.error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®è§£æã«å¤±æ•—:', e.message);
                        }
                    }
                    
                    showAlert('AIå•é¡Œç”Ÿæˆã‚¨ãƒ©ãƒ¼', `AIå•é¡Œç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n${errorMessage}\n\nã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`);
                    return null;
                } finally {
                    setIsLoading(false);
                }
            };

            // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            const ConfirmDialog = ({ show, config, onClose }) => {
                if (!show) return null;

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                            <div className="p-6">
                                <h3 className="text-lg font-bold text-gray-900 mb-3">
                                    {config.title || 'ç¢ºèª'}
                                </h3>
                                <div className="text-gray-700 mb-6 whitespace-pre-line">
                                    {config.message}
                                </div>
                                <div className="flex flex-col sm:flex-row gap-3 sm:justify-end">
                                    <button
                                        onClick={() => {
                                            if (config.onCancel) config.onCancel();
                                            onClose();
                                        }}
                                        className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-medium"
                                    >
                                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (config.onConfirm) config.onConfirm();
                                            onClose();
                                        }}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                                    >
                                        å®Ÿè¡Œã™ã‚‹
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½¿ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const showConfirm = (title, message, onConfirm, onCancel = null) => {
                setConfirmConfig({ title, message, onConfirm, onCancel });
                setShowConfirmDialog(true);
            };

            // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½¿ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const showAlert = (title, message) => {
                setConfirmConfig({ 
                    title, 
                    message, 
                    onConfirm: () => {}, 
                    onCancel: null 
                });
                setShowConfirmDialog(true);
            };

            // ç®¡ç†ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            const AdminSection = () => {
                const [selectedSubject, setSelectedSubject] = useState('math');
                const [selectedGrade, setSelectedGrade] = useState('ä¸­2');
                const [selectedUnit, setSelectedUnit] = useState('å…¨åˆ†é‡');
                const [selectedLevel, setSelectedLevel] = useState('åŸºç¤');
                const [batchCount, setBatchCount] = useState(5);

                const gradeOptions = ['ä¸­1', 'ä¸­2', 'ä¸­3', 'é«˜1'];
                const mathUnitsByGrade = {
                    'ä¸­1': ['å…¨åˆ†é‡', 'æ­£è² ã®æ•°', 'æ–‡å­—å¼', 'ä¸€æ¬¡æ–¹ç¨‹å¼', 'æ¯”ä¾‹ãƒ»åæ¯”ä¾‹'],
                    'ä¸­2': ['å…¨åˆ†é‡', 'å¼ã®è¨ˆç®—', 'é€£ç«‹æ–¹ç¨‹å¼', 'ä¸€æ¬¡é–¢æ•°', 'å›³å½¢ã®æ€§è³ª'],
                    'ä¸­3': ['å…¨åˆ†é‡', 'å¼ã®å±•é–‹ãƒ»å› æ•°åˆ†è§£', 'å¹³æ–¹æ ¹', 'äºŒæ¬¡æ–¹ç¨‹å¼', 'äºŒæ¬¡é–¢æ•°'],
                    'é«˜1': ['å…¨åˆ†é‡', 'æ•°ã¨å¼', 'é›†åˆã¨å‘½é¡Œ', 'äºŒæ¬¡é–¢æ•°', 'å›³å½¢ã¨è¨ˆé‡']
                };
                const levelOptions = [
                    { value: 'åŸºç¤', description: 'åŸºæœ¬çš„ãªè¨ˆç®—ãƒ»å…¬å¼ã®ç¢ºèª' },
                    { value: 'æ¨™æº–', description: 'å®šæœŸãƒ†ã‚¹ãƒˆãƒ»æ•™ç§‘æ›¸ãƒ¬ãƒ™ãƒ«' },
                    { value: 'å¿œç”¨', description: 'æ€è€ƒåŠ›ãƒ»è¤‡åˆå•é¡Œ' },
                    { value: 'ç™ºå±•', description: 'å…¥è©¦ãƒ¬ãƒ™ãƒ«ãƒ»é«˜åº¦ãªå•é¡Œ' }
                ];

                const handleBatchGenerate = async () => {
                    if (!apiStatus.connected) {
                        showAlert('AIæ¥ç¶šã‚¨ãƒ©ãƒ¼', 'AIæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚APIã‚­ãƒ¼ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    const confirmMessage = `${batchCount}å•ã®${selectedSubject === 'math' ? 'æ•°å­¦' : 'è‹±èª'}å•é¡Œã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã€‚\n\nè¨­å®šè©³ç´°:\nãƒ»å­¦å¹´: ${selectedGrade}\nãƒ»åˆ†é‡: ${selectedUnit}\nãƒ»é›£æ˜“åº¦: ${selectedLevel}ãƒ¬ãƒ™ãƒ«\nãƒ»ç”Ÿæˆæ•°: ${batchCount}å•\n\nâ€»ä¸€åº¦ã«${batchCount}å•ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã€é€šå¸¸ã‚ˆã‚Šæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™`;
                    
                    showConfirm(
                        'ğŸ¤– AIä¸€æ‹¬å•é¡Œç”Ÿæˆã®ç¢ºèª',
                        confirmMessage,
                        async () => {
                            await generateBatchProblemsForPool(selectedSubject, selectedGrade, selectedUnit, selectedLevel, batchCount);
                        }
                    );
                };

                const handleAddToPool = async (problem) => {
                    const success = await addProblemToPool(problem);
                    if (success) {
                        // è¿½åŠ æ¸ˆã¿ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã‚‹
                        setGeneratedProblems(prev => 
                            prev.map(p => p === problem ? { ...p, addedToPool: true } : p)
                        );
                    }
                };

                // ä¸€æ‹¬ãƒ—ãƒ¼ãƒ«è¿½åŠ é–¢æ•°
                const handleBatchAddToPool = async (problems) => {
                    try {
                        console.log(`ğŸš€ ${problems.length}å•ã®ä¸€æ‹¬ãƒ—ãƒ¼ãƒ«è¿½åŠ é–‹å§‹`);
                        
                        const API_URL = window.CARITAS_API_URL;
                        const response = await fetch(`${API_URL}/api/problem-pool/add-batch`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ problems })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        }

                        const data = await response.json();
                        
                        console.log('APIå¿œç­”ãƒ‡ãƒ¼ã‚¿:', data);
                        
                        if (data.success || (data.success_count && data.success_count > 0)) {
                            const successCount = data.success_count || 0;
                            const failureCount = data.failure_count || 0;
                            
                            console.log(`âœ… ä¸€æ‹¬ãƒ—ãƒ¼ãƒ«è¿½åŠ å®Œäº†: æˆåŠŸ${successCount}å•, å¤±æ•—${failureCount}å•`);
                            
                            // æˆåŠŸã—ãŸå•é¡Œã«è¿½åŠ æ¸ˆã¿ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã‚‹
                            if (data.results && Array.isArray(data.results)) {
                                const successfulResults = data.results.filter(r => r.success);
                                const successfulIndices = successfulResults.map(r => r.index);
                                
                                setGeneratedProblems(prev => 
                                    prev.map((p, globalIndex) => {
                                        // ã“ã®å•é¡ŒãŒä»Šå›è¿½åŠ å¯¾è±¡ã ã£ãŸå ´åˆ
                                        const localIndex = problems.findIndex(prob => prob === p);
                                        if (localIndex !== -1 && successfulIndices.includes(localIndex)) {
                                            return { ...p, addedToPool: true };
                                        }
                                        return p;
                                    })
                                );
                            }

                            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
                            try {
                                await fetchProblemPoolStats();
                            } catch (statsError) {
                                console.warn('çµ±è¨ˆæƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼:', statsError);
                            }
                            
                            // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                            const message = failureCount > 0
                                ? `ä¸€æ‹¬è¿½åŠ å®Œäº†\n\næˆåŠŸ: ${successCount}å•\nå¤±æ•—: ${failureCount}å•\n\nä¸€éƒ¨ã®å•é¡Œã§è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`
                                : `ğŸ‰ ${successCount}å•ã®ä¸€æ‹¬è¿½åŠ ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nå•é¡Œãƒ—ãƒ¼ãƒ«ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚`;
                            
                            showAlert('ä¸€æ‹¬è¿½åŠ çµæœ', message);
                            
                        } else {
                            throw new Error(data.error || data.message || 'ä¸€æ‹¬è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                        
                    } catch (error) {
                        console.error('ä¸€æ‹¬ãƒ—ãƒ¼ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                        showAlert('ä¸€æ‹¬è¿½åŠ ã‚¨ãƒ©ãƒ¼', `ä¸€æ‹¬ãƒ—ãƒ¼ãƒ«è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.message}\n\nã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    }
                };

                const handleAddAllToPool = async () => {
                    const unadded = generatedProblems.filter(p => !p.addedToPool);
                    if (unadded.length === 0) {
                        showAlert('è¿½åŠ ã§ãã¾ã›ã‚“', 'è¿½åŠ å¯èƒ½ãªå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nå…ˆã«å•é¡Œã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    const confirmMessage = `ç”Ÿæˆã•ã‚ŒãŸ${unadded.length}å•ã‚’ãƒ—ãƒ¼ãƒ«ã«ä¸€æ‹¬è¿½åŠ ã—ã¾ã™ã€‚\n\nè¿½åŠ ã•ã‚Œã‚‹å•é¡Œ:\n${unadded.map((p, i) => `${i+1}. ${p.grade} ${p.unit} (${p.level})`).join('\n')}\n\nãƒ—ãƒ¼ãƒ«ã«è¿½åŠ ã™ã‚‹ã¨ã€ä»Šå¾Œã®å­¦ç¿’ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`;
                    
                    showConfirm(
                        'ğŸ“š ãƒ—ãƒ¼ãƒ«ä¸€æ‹¬è¿½åŠ ã®ç¢ºèª',
                        confirmMessage,
                        async () => {
                            await handleBatchAddToPool(unadded);
                        }
                    );
                };

                return (
                    <div className="space-y-4 sm:space-y-6">
                        {/* ç®¡ç†ç”»é¢ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                        <div className="bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4 sm:p-6 rounded-lg">
                            <h2 className="text-xl sm:text-2xl font-bold mb-2">âš™ï¸ å•é¡Œãƒ—ãƒ¼ãƒ«ç®¡ç†ç”»é¢</h2>
                            <p className="text-sm sm:text-base opacity-90">AIå•é¡Œç”Ÿæˆ â†’ ãƒ—ãƒ¼ãƒ«è¿½åŠ ã§å•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ§‹ç¯‰</p>
                        </div>

                        {/* çµ±è¨ˆæƒ…å ± */}
                        {problemPoolStats && (
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow border">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    ğŸ“Š ç¾åœ¨ã®ãƒ—ãƒ¼ãƒ«çµ±è¨ˆ
                                </h3>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                                    <div className="bg-blue-50 p-3 rounded-lg">
                                        <div className="text-2xl font-bold text-blue-700">{problemPoolStats.total_problems}</div>
                                        <div className="text-sm text-blue-600">ç·å•é¡Œæ•°</div>
                                    </div>
                                    {Object.entries(problemPoolStats.problems_by_level || {}).map(([level, count]) => (
                                        <div key={level} className="bg-gray-50 p-3 rounded-lg">
                                            <div className="text-xl font-bold text-gray-700">{count}</div>
                                            <div className="text-sm text-gray-600">{level}ãƒ¬ãƒ™ãƒ«</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* å•é¡Œç”Ÿæˆè¨­å®š */}
                        <div className="bg-white p-4 sm:p-6 rounded-lg shadow border">
                            <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                ğŸ¤– å•é¡Œç”Ÿæˆè¨­å®š
                            </h3>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">ç§‘ç›®</label>
                                    <select
                                        value={selectedSubject}
                                        onChange={(e) => setSelectedSubject(e.target.value)}
                                        className="w-full p-2 sm:p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-sm"
                                    >
                                        <option value="math">æ•°å­¦</option>
                                        <option value="english" disabled>è‹±èªï¼ˆæº–å‚™ä¸­ï¼‰</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">å­¦å¹´</label>
                                    <select
                                        value={selectedGrade}
                                        onChange={(e) => setSelectedGrade(e.target.value)}
                                        className="w-full p-2 sm:p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-sm"
                                    >
                                        {gradeOptions.map(grade => (
                                            <option key={grade} value={grade}>{grade}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">åˆ†é‡</label>
                                    <select
                                        value={selectedUnit}
                                        onChange={(e) => setSelectedUnit(e.target.value)}
                                        className="w-full p-2 sm:p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-sm"
                                        disabled={selectedSubject !== 'math'}
                                    >
                                        {selectedSubject === 'math' && mathUnitsByGrade[selectedGrade].map(unit => (
                                            <option key={unit} value={unit}>{unit}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">é›£æ˜“åº¦</label>
                                    <select
                                        value={selectedLevel}
                                        onChange={(e) => setSelectedLevel(e.target.value)}
                                        className="w-full p-2 sm:p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-sm"
                                    >
                                        {levelOptions.map(level => (
                                            <option key={level.value} value={level.value}>
                                                {level.value}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            {/* ç”Ÿæˆæ•°è¨­å®šã¨å®Ÿè¡Œãƒœã‚¿ãƒ³ */}
                            <div className="flex flex-col sm:flex-row gap-4 items-end">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">ç”Ÿæˆæ•°</label>
                                    <select
                                        value={batchCount}
                                        onChange={(e) => setBatchCount(parseInt(e.target.value))}
                                        className="w-full p-2 sm:p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-sm"
                                    >
                                        <option value={5}>5å•</option>
                                        <option value={10}>10å•</option>
                                        <option value={20}>20å•</option>
                                    </select>
                                </div>
                                
                                <button
                                    onClick={handleBatchGenerate}
                                    disabled={!apiStatus.connected || isGenerating}
                                    className={`px-6 py-3 rounded-lg font-medium transition-all ${
                                        apiStatus.connected && !isGenerating
                                            ? 'bg-purple-600 text-white hover:bg-purple-700 active:bg-purple-800' 
                                            : 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                    }`}
                                >
                                    {isGenerating ? (
                                        <>ğŸ”„ {batchCount}å•ã‚’ä¸€æ‹¬ç”Ÿæˆä¸­...</>
                                    ) : (
                                        <>ğŸš€ {batchCount}å•ã‚’ä¸€æ‹¬ç”Ÿæˆ</>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* ç”Ÿæˆã•ã‚ŒãŸå•é¡Œãƒªã‚¹ãƒˆ */}
                        {generatedProblems.length > 0 && (
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow border">
                                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                                    <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                        ğŸ“ ç”Ÿæˆã•ã‚ŒãŸå•é¡Œ ({generatedProblems.length}å•)
                                    </h3>
                                    <button
                                        onClick={handleAddAllToPool}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-medium"
                                    >
                                        ğŸ“š å…¨ã¦ã‚’ãƒ—ãƒ¼ãƒ«ã«è¿½åŠ 
                                    </button>
                                </div>
                                
                                <div className="space-y-4 max-h-96 overflow-y-auto">
                                    {generatedProblems.map((problem, index) => (
                                        <div key={index} className="border border-gray-200 rounded-lg p-4">
                                            <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-3">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-sm font-medium text-gray-600">
                                                        {problem.grade} / {problem.unit} / {problem.level}
                                                    </span>
                                                    {problem.addedToPool && (
                                                        <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">
                                                            âœ… è¿½åŠ æ¸ˆã¿
                                                        </span>
                                                    )}
                                                </div>
                                                {!problem.addedToPool && (
                                                    <button
                                                        onClick={() => handleAddToPool(problem)}
                                                        className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                                                    >
                                                        ğŸ“š ãƒ—ãƒ¼ãƒ«ã«è¿½åŠ 
                                                    </button>
                                                )}
                                            </div>
                                            
                                            <div className="bg-gray-50 p-3 rounded text-sm">
                                                <p className="font-medium text-gray-800 mb-2">å•é¡Œ:</p>
                                                <p className="text-gray-700 whitespace-pre-wrap">{problem.problem}</p>
                                                {problem.answer && (
                                                    <>
                                                        <p className="font-medium text-gray-800 mt-3 mb-1">è§£ç­”:</p>
                                                        <p className="text-green-700 font-medium">{problem.answer}</p>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // æ•°å­¦å­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const MathSection = ({
                studyMode, setStudyMode, studySettings, setStudySettings,
                mathCurrentProblem, setMathCurrentProblem, mathIsLoading, setMathIsLoading,
                mathProgress, setMathProgress, apiStatus, problemPoolStats, showAlert,
                getProblemFromPool, generateMathProblem
            }) => {
                const [selectedGrade, setSelectedGrade] = useState('ä¸­2');
                const [selectedUnit, setSelectedUnit] = useState('å…¨åˆ†é‡');
                const [selectedLevel, setSelectedLevel] = useState('åŸºç¤');
                const [showSteps, setShowSteps] = useState(false);
                const [currentStep, setCurrentStep] = useState(0);
                
                const [problemCount, setProblemCount] = useState(1);
                const [usePool, setUsePool] = useState(true); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ—ãƒ¼ãƒ«ã‚’ä½¿ç”¨
                
                // studyModeã®å¤‰åŒ–ã‚’è©³ç´°è¿½è·¡
                useEffect(() => {
                    console.log('ğŸ” [çŠ¶æ…‹è¿½è·¡] studyModeå¤‰åŒ–:', studyMode, new Date().toISOString());
                    console.log('ğŸ” [çŠ¶æ…‹è©³ç´°] ç¾åœ¨ã®å…¨çŠ¶æ…‹:', {
                        studyMode,
                        mathCurrentProblem: !!mathCurrentProblem,
                        mathIsLoading,
                        studySettings: !!studySettings,
                        problemCount
                    });
                    
                    if (studyMode === 'studying') {
                        console.log('âœ… [é‡è¦] studyModeãŒ"studying"ã«å¤‰åŒ–ã—ã¾ã—ãŸï¼');
                    }
                    
                    if (studyMode === 'setup') {
                        console.log('ğŸ”´ [é‡è¦] studyModeãŒ"setup"ã«å¤‰åŒ–ã—ã¾ã—ãŸ');
                        if (mathCurrentProblem || studySettings) {
                            console.log('âš ï¸ [ç•°å¸¸] setupã«æˆ»ã£ãŸãŒå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒæ®‹å­˜:', {
                                mathCurrentProblem: !!mathCurrentProblem,
                                studySettings: !!studySettings
                            });
                        }
                    }
                }, [studyMode]);

                // å•é¡ŒçŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç›£è¦–ï¼ˆä¾å­˜é–¢ä¿‚ã‚’åˆ¶é™ï¼‰
                useEffect(() => {
                    if (mathCurrentProblem && studyMode === 'studying') {
                        console.log('ğŸ”„ useEffect - å•é¡Œè¡¨ç¤ºç¢ºèª:', {
                            mathCurrentProblem: !!mathCurrentProblem,
                            studyMode,
                            problemId: mathCurrentProblem.id
                        });
                    }
                }, [mathCurrentProblem]); // studyModeã‚’ä¾å­˜é–¢ä¿‚ã‹ã‚‰é™¤å¤–

                // showStepsã®çŠ¶æ…‹å¤‰åŒ–ã‚’ç›£è¦–
                useEffect(() => {
                    console.log('ğŸ” [showStepsçŠ¶æ…‹] showStepså¤‰åŒ–:', showSteps);
                    if (showSteps) {
                        console.log('ğŸ” [è§£èª¬è¡¨ç¤º] è§£èª¬è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ');
                        console.log('ğŸ” [å•é¡Œç¢ºèª] mathCurrentProblem:', mathCurrentProblem);
                        console.log('ğŸ” [ã‚¹ãƒ†ãƒƒãƒ—ç¢ºèª] steps:', mathCurrentProblem?.steps);
                    }
                }, [showSteps]);


                const gradeOptions = ['ä¸­1', 'ä¸­2', 'ä¸­3', 'é«˜1'];
                const unitsByGrade = {
                    'ä¸­1': ['å…¨åˆ†é‡', 'æ­£è² ã®æ•°', 'æ–‡å­—å¼', 'ä¸€æ¬¡æ–¹ç¨‹å¼', 'æ¯”ä¾‹ãƒ»åæ¯”ä¾‹'],
                    'ä¸­2': ['å…¨åˆ†é‡', 'å¼ã®è¨ˆç®—', 'é€£ç«‹æ–¹ç¨‹å¼', 'ä¸€æ¬¡é–¢æ•°', 'å›³å½¢ã®æ€§è³ª'],
                    'ä¸­3': ['å…¨åˆ†é‡', 'å¼ã®å±•é–‹ãƒ»å› æ•°åˆ†è§£', 'å¹³æ–¹æ ¹', 'äºŒæ¬¡æ–¹ç¨‹å¼', 'äºŒæ¬¡é–¢æ•°'],
                    'é«˜1': ['å…¨åˆ†é‡', 'æ•°ã¨å¼', 'é›†åˆã¨å‘½é¡Œ', 'äºŒæ¬¡é–¢æ•°', 'å›³å½¢ã¨è¨ˆé‡']
                };
                const levelOptions = [
                    { value: 'åŸºç¤', description: 'åŸºæœ¬çš„ãªè¨ˆç®—ãƒ»å…¬å¼ã®ç¢ºèª' },
                    { value: 'æ¨™æº–', description: 'å®šæœŸãƒ†ã‚¹ãƒˆãƒ»æ•™ç§‘æ›¸ãƒ¬ãƒ™ãƒ«' },
                    { value: 'å¿œç”¨', description: 'æ€è€ƒåŠ›ãƒ»è¤‡åˆå•é¡Œ' },
                    { value: 'ç™ºå±•', description: 'å…¥è©¦ãƒ¬ãƒ™ãƒ«ãƒ»é«˜åº¦ãªå•é¡Œ' }
                ];

                // å­¦ç¿’é–‹å§‹é–¢æ•°
                const startStudySession = async () => {
                    // å‘¼ã³å‡ºã—å…ƒã‚’ç‰¹å®š
                    console.log('ğŸš€ğŸš€ğŸš€ [è¨ºæ–­] startStudySessioné–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
                    console.log('ğŸ” [å‘¼ã³å‡ºã—å…ƒ] ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', new Error().stack);
                    
                    // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
                    if (mathIsLoading || studyMode === 'studying') {
                        console.log('âš ï¸ [é‡è¤‡é˜²æ­¢] å­¦ç¿’é–‹å§‹å‡¦ç†ãŒæ—¢ã«å®Ÿè¡Œä¸­ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
                        return;
                    }
                    
                    console.log('ğŸš€ğŸš€ğŸš€ [è¨ºæ–­] å­¦ç¿’é–‹å§‹å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™');
                    console.log('ğŸ” [è¨ºæ–­] ç¾åœ¨ã®çŠ¶æ…‹è©³ç´°:', {
                        selectedGrade,
                        selectedUnit,
                        selectedLevel,
                        usePool,
                        apiConnected: apiStatus.connected,
                        problemPoolStats,
                        currentStudyMode: studyMode,
                        currentMathProblem: mathCurrentProblem,
                        currentLoading: mathIsLoading
                    });
                    
                    const settings = {
                        grade: selectedGrade,
                        unit: selectedUnit,
                        level: selectedLevel,
                        usePool,
                        startTime: new Date()
                    };
                    console.log('ğŸ“‹ [è¨ºæ–­] å­¦ç¿’è¨­å®š:', settings);
                    
                    try {
                        console.log('ğŸ”„ [è¨ºæ–­] çŠ¶æ…‹æ›´æ–°é–‹å§‹...');
                        
                        // çŠ¶æ…‹æ›´æ–°ã‚’é †æ¬¡å®Ÿè¡Œ
                        setStudySettings(settings);
                        console.log('âœ… [è¨ºæ–­] setStudySettingså®Œäº†');
                        
                        setStudyMode('studying');
                        console.log('âœ… [è¨ºæ–­] setStudyMode("studying")å®Œäº†');
                        
                        setProblemCount(1);
                        console.log('âœ… [è¨ºæ–­] setProblemCount(1)å®Œäº†');
                        
                        setMathCurrentProblem(null);
                        console.log('âœ… [è¨ºæ–­] setMathCurrentProblem(null)å®Œäº†');
                        
                        setShowSteps(false);
                        console.log('âœ… [è¨ºæ–­] setShowSteps(false)å®Œäº†');
                        
                        setCurrentStep(0);
                        console.log('âœ… [è¨ºæ–­] setCurrentStep(0)å®Œäº†');
                        
                        console.log('ğŸ”„ [è¨ºæ–­] å…¨ã¦ã®çŠ¶æ…‹æ›´æ–°å®Œäº† - studyMode: studying');
                        
                        // ReactçŠ¶æ…‹æ›´æ–°ã®å®Œäº†ã‚’ç¢ºå®Ÿã«å¾…ã¤
                        await new Promise(resolve => setTimeout(resolve, 200));
                        console.log('â±ï¸ [è¨ºæ–­] çŠ¶æ…‹æ›´æ–°å¾…æ©Ÿå®Œäº†');
                        
                        // studyModeãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                        console.log('ğŸ” [ç¢ºèª] çŠ¶æ…‹æ›´æ–°å¾Œã®studyModeç¢ºèªãŒå¿…è¦');
                        
                        // æœ€åˆã®å•é¡Œã‚’å–å¾—ï¼ˆå®Œäº†ã¾ã§å¾…æ©Ÿï¼‰
                        console.log('ğŸ“¥ [è¨ºæ–­] å•é¡Œå–å¾—ã‚’é–‹å§‹ã—ã¾ã™');
                        const result = await getNextProblem(settings);
                        console.log('âœ… [è¨ºæ–­] getNextProblemå®Œäº†:', result ? 'SUCCESS' : 'FAILED');
                        
                        if (result) {
                            console.log('ğŸ‰ [è¨ºæ–­] å­¦ç¿’é–‹å§‹æˆåŠŸï¼å•é¡ŒãŒå–å¾—ã§ãã¾ã—ãŸ');
                            // å¼·åˆ¶çš„ã«studyModeã‚’å†è¨­å®š
                            console.log('ğŸ”§ [ä¿®æ­£] studyModeã‚’å¼·åˆ¶çš„ã«"studying"ã«å†è¨­å®š');
                            setStudyMode('studying');
                        } else {
                            console.log('âŒ [è¨ºæ–­] å­¦ç¿’é–‹å§‹å¤±æ•—ï¼šå•é¡ŒãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                            console.log('ğŸ”´ [é‡è¦] å•é¡Œå–å¾—å¤±æ•—ã«ã‚ˆã‚Šè¨­å®šç”»é¢ã«æˆ»ã‚Šã¾ã™');
                            backToSetup();
                            return; // æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
                        }
                        
                    } catch (error) {
                        console.error('âŒ [è¨ºæ–­] startStudySession ã‚¨ãƒ©ãƒ¼:', error);
                        console.log('ğŸ”´ [é‡è¦] startStudySessionã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ - backToSetup()ã‚’å‘¼ã³å‡ºã—ã¾ã™');
                        backToSetup();
                        showAlert('å­¦ç¿’é–‹å§‹ã‚¨ãƒ©ãƒ¼', `å­¦ç¿’é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    }
                };

                // æ¬¡ã®å•é¡Œå–å¾—é–¢æ•°
                const getNextProblem = async (settings = studySettings) => {
                    // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
                    if (mathIsLoading) {
                        console.log('âš ï¸ [é‡è¤‡é˜²æ­¢] å•é¡Œå–å¾—ãŒæ—¢ã«å®Ÿè¡Œä¸­ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
                        return null;
                    }
                    
                    console.log('ğŸ” ãƒ‡ãƒãƒƒã‚° - getNextProblemé–‹å§‹:', {
                        settings,
                        studySettings,
                        usePool: settings?.usePool,
                        grade: settings?.grade,
                        unit: settings?.unit,
                        level: settings?.level
                    });
                    
                    // å•é¡Œã‚«ã‚¦ãƒ³ãƒˆã‚’å…ˆã«æ›´æ–°ï¼ˆUIã®åŒæœŸã‚’æ”¹å–„ï¼‰
                    setProblemCount(prev => prev + 1);
                    
                    setMathCurrentProblem(null);
                    setShowSteps(false);
                    setCurrentStep(0);
                    setMathIsLoading(true);
                    
                    let problem = null;
                    try {
                        console.log('ğŸ“¥ å•é¡Œå–å¾—é–‹å§‹:', settings.usePool ? 'ãƒ—ãƒ¼ãƒ«ã‹ã‚‰å–å¾—' : 'AIç”Ÿæˆ');
                        
                        if (settings.usePool) {
                            console.log('ğŸ“š ãƒ—ãƒ¼ãƒ«å•é¡Œå–å¾—ã‚’è©¦è¡Œä¸­...');
                            problem = await getProblemFromPool(settings.grade, settings.unit, settings.level);
                        } else {
                            console.log('ğŸ¤– AIå•é¡Œç”Ÿæˆã‚’è©¦è¡Œä¸­...');
                            problem = await generateMathProblem(settings.grade, settings.unit, settings.level);
                        }
                        
                        console.log('ğŸ” å•é¡Œå–å¾—çµæœ:', {
                            problemExists: !!problem,
                            problemId: problem?.id,
                            problemGrade: problem?.grade,
                            problemUnit: problem?.unit,
                            problemLevel: problem?.level
                        });
                        
                        if (problem) {
                            // å•é¡Œå–å¾—æˆåŠŸæ™‚ã¯å³åº§ã«çŠ¶æ…‹ã‚’æ›´æ–°
                            setMathCurrentProblem(problem);
                            setMathIsLoading(false);
                            
                            // é€²æ—æ›´æ–°
                            setMathProgress(prev => ({
                                ...prev,
                                solved: prev.solved + 1
                            }));
                            
                            console.log('âœ… mathCurrentProblemæ›´æ–°å®Œäº†');
                            return problem;
                        } else {
                            console.log('âŒ å•é¡Œå–å¾—å¤±æ•— - problemãŒnull');
                            setMathIsLoading(false);
                            return null;
                        }
                    } catch (error) {
                        console.error('âŒ getNextProblem ã‚¨ãƒ©ãƒ¼:', error);
                        console.log('ğŸ”´ [é‡è¦] getNextProblemã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ - çŠ¶æ…‹ç¢ºèª:', {
                            studyMode,
                            mathCurrentProblem: !!mathCurrentProblem,
                            mathIsLoading,
                            errorMessage: error.message
                        });
                        setMathIsLoading(false);
                        showAlert('å•é¡Œå–å¾—ã‚¨ãƒ©ãƒ¼', `å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        return null;
                    }
                };

                // è¨­å®šç”»é¢ã«æˆ»ã‚‹é–¢æ•°
                const backToSetup = () => {
                    console.log('ğŸ”´ [é‡è¦] backToSetupé–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸï¼', {
                        currentStudyMode: studyMode,
                        callStack: new Error().stack
                    });
                    setStudyMode('setup');
                    setMathCurrentProblem(null);
                    setShowSteps(false);
                    setCurrentStep(0);
                    setStudySettings(null);
                    setProblemCount(1);
                };


                // ä¿®æ­£ï¼šå˜ç´”åŒ–ã•ã‚ŒãŸæ¡ä»¶åˆ†å²
                console.log('ğŸ” [ä¿®æ­£] ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åˆ¤å®š:', {
                    studyMode,
                    mathCurrentProblem: !!mathCurrentProblem,
                    mathIsLoading,
                    studySettings: !!studySettings
                });
                
                // **é‡è¦**ï¼šå…¨ã¦ã®æ¡ä»¶ã‚’è©³ç´°ã«ãƒ­ã‚°å‡ºåŠ›
                console.log('ğŸ” [æ¡ä»¶åˆ¤å®š] å„æ¡ä»¶ã®è©³ç´°ãƒã‚§ãƒƒã‚¯:', {
                    'æ¡ä»¶1_å•é¡Œè¡¨ç¤º': `studyMode === 'studying'(${studyMode === 'studying'}) && mathCurrentProblem(${!!mathCurrentProblem}) && !mathIsLoading(${!mathIsLoading})`,
                    'æ¡ä»¶2_ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°': `mathIsLoading(${mathIsLoading})`,
                    'æ¡ä»¶3_å¾…æ©ŸçŠ¶æ…‹': `studyMode === 'studying'(${studyMode === 'studying'}) && !mathCurrentProblem(${!mathCurrentProblem}) && !mathIsLoading(${!mathIsLoading})`,
                    'æ¡ä»¶4_è¨­å®šãƒ¢ãƒ¼ãƒ‰': `studyMode === 'setup'(${studyMode === 'setup'})`
                });

                // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã§å•é¡ŒãŒã‚ã‚‹å ´åˆï¼šå•é¡Œè¡¨ç¤º
                if (studyMode === 'studying' && mathCurrentProblem && !mathIsLoading) {
                    console.log('âœ… [ä¿®æ­£] å•é¡Œè¡¨ç¤ºç”»é¢ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°');
                    console.log('ğŸ” [ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°] showSteps:', showSteps);
                    console.log('ğŸ” [ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°] mathCurrentProblem.steps:', mathCurrentProblem.steps);
                    
                    return (
                        <div className="space-y-4 sm:space-y-6">
                            {/* å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ± */}
                            {studySettings && (
                                <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg">
                                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                        <div>
                                            <h2 className="text-lg font-bold">ğŸ¯ å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­</h2>
                                            <p className="text-sm opacity-90">
                                                {studySettings.grade} | {studySettings.unit} | {studySettings.level}ãƒ¬ãƒ™ãƒ«
                                            </p>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="text-center">
                                                <div className="text-xl font-bold">{problemCount - 1}</div>
                                                <div className="text-xs opacity-80">å•é¡Œç›®</div>
                                            </div>
                                            <button
                                                onClick={backToSetup}
                                                className="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm font-medium transition-all"
                                            >
                                                âš™ï¸ è¨­å®šå¤‰æ›´
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªå•é¡Œè¡¨ç¤º */}
                            <div className="bg-blue-50 p-4 sm:p-6 rounded-lg">
                                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-4 mb-4">
                                    <h3 className="text-lg sm:text-xl font-bold text-blue-900">
                                        {mathCurrentProblem.source === 'pool' ? 'ğŸ“š' : 'ğŸ¤–'} {mathCurrentProblem.source === 'pool' ? 'ãƒ—ãƒ¼ãƒ«å•é¡Œ' : 'AIç”Ÿæˆå•é¡Œ'} - {mathCurrentProblem.grade} {mathCurrentProblem.unit}
                                    </h3>
                                    <span className={`self-start sm:self-auto px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium ${
                                        mathCurrentProblem.level === 'åŸºç¤' ? 'bg-green-200 text-green-800' :
                                        mathCurrentProblem.level === 'æ¨™æº–' ? 'bg-blue-200 text-blue-800' :
                                        mathCurrentProblem.level === 'å¿œç”¨' ? 'bg-orange-200 text-orange-800' :
                                        'bg-red-200 text-red-800'
                                    }`}>
                                        {mathCurrentProblem.level}ãƒ¬ãƒ™ãƒ«
                                    </span>
                                </div>
                                
                                <div className="bg-white p-4 sm:p-6 rounded border-l-4 border-blue-500">
                                    <p className="text-base sm:text-lg font-medium mb-4 whitespace-pre-wrap leading-relaxed">{mathCurrentProblem.problem}</p>
                                    {mathCurrentProblem.hint && (
                                        <div className="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400">
                                            <p className="text-sm text-yellow-800">
                                                ğŸ’¡ <strong>ãƒ’ãƒ³ãƒˆ:</strong> {mathCurrentProblem.hint}
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {!showSteps ? (
                                <div className="flex flex-col sm:flex-row gap-3 sm:gap-4">
                                    <button
                                        onClick={() => setShowSteps(true)}
                                        className="bg-blue-600 text-white px-4 sm:px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 flex items-center justify-center gap-2 touch-manipulation font-medium"
                                    >
                                        ğŸ§  <span className="sm:hidden">è§£èª¬ã‚’è¦‹ã‚‹</span><span className="hidden sm:inline">AIè©³ç´°è§£èª¬ã‚’è¦‹ã‚‹</span>
                                    </button>
                                    <button
                                        onClick={() => getNextProblem()}
                                        className="bg-green-600 text-white px-4 sm:px-6 py-3 rounded-lg hover:bg-green-700 active:bg-green-800 touch-manipulation font-medium"
                                    >
                                        ğŸ”„ <span className="sm:hidden">æ¬¡ã®å•é¡Œ</span><span className="hidden sm:inline">æ¬¡ã®å•é¡Œã‚’{studySettings?.usePool ? 'å–å¾—' : 'ç”Ÿæˆ'}</span>
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {/* è§£èª¬ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã¯å¾Œã§è¿½åŠ  */}
                                    <div className="bg-gray-50 p-4 sm:p-6 rounded-lg">
                                        <h4 className="font-bold text-base sm:text-lg mb-4">ğŸ¤– AIç”Ÿæˆï¼šè©³ç´°è§£èª¬</h4>
                                        <div className="bg-green-50 p-3 sm:p-4 rounded-lg">
                                            <h4 className="font-bold text-green-900 mb-2 text-sm sm:text-base">âœ… è§£ç­”</h4>
                                            <p className="text-green-800 text-base sm:text-lg font-medium whitespace-pre-wrap">{mathCurrentProblem.answer}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex flex-col sm:flex-row gap-3 sm:gap-4">
                                        <button
                                            onClick={() => setShowSteps(false)}
                                            className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 active:bg-gray-800 touch-manipulation font-medium text-sm"
                                        >
                                            ğŸ“‹ å•é¡Œã«æˆ»ã‚‹
                                        </button>
                                        <button
                                            onClick={() => getNextProblem()}
                                            className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 active:bg-green-800 touch-manipulation font-medium text-sm"
                                        >
                                            ğŸ”„ æ¬¡ã®å•é¡Œã‚’{studySettings?.usePool ? 'å–å¾—' : 'ç”Ÿæˆ'}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                }

                // å„ªå…ˆé †ä½2: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­
                if (mathIsLoading) {
                    console.log('ğŸ” ãƒ‡ãƒãƒƒã‚° - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢è¡¨ç¤ºä¸­:', {
                        mathIsLoading,
                        studyMode,
                        studySettings: studySettings?.usePool ? 'ãƒ—ãƒ¼ãƒ«' : 'AIç”Ÿæˆ'
                    });
                    
                    return (
                        <div className="flex items-center justify-center min-h-64 p-4">
                            <div className="text-center max-w-sm mx-auto">
                                <div className="text-4xl sm:text-6xl mb-4 pulse-animation">
                                    {studySettings?.usePool ? 'ğŸ“š' : 'ğŸ¤–'}
                                </div>
                                <div className="text-lg sm:text-xl font-bold text-blue-600 mb-2">
                                    {studySettings?.usePool ? 'å•é¡Œãƒ—ãƒ¼ãƒ«ã‹ã‚‰å–å¾—ä¸­' : 'AIãŒé«˜å“è³ªãªå•é¡Œã‚’ç”Ÿæˆä¸­'}<span className="loading-dots"></span>
                                </div>
                                <div className="text-xs sm:text-sm text-gray-600 mb-4">
                                    {studySettings?.usePool ? 'å•é¡Œãƒ—ãƒ¼ãƒ«ã‹ã‚‰æœ€é©ãªå•é¡Œã‚’é¸æŠã—ã¦ã„ã¾ã™' : 'ä½“ç³»æ•°å­¦ã«æº–æ‹ ã—ãŸæ€è€ƒåŠ›å•é¡Œã‚’ä½œæˆã—ã¦ã„ã¾ã™'}
                                </div>
                                <div className="w-48 sm:w-64 bg-gray-200 rounded-full h-2 mx-auto">
                                    <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{width: '75%'}}></div>
                                </div>
                                
                                {/* å­¦ç¿’ä¸­ã¯ä¸­æ–­ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */}
                                {studyMode === 'studying' && (
                                    <button
                                        onClick={backToSetup}
                                        className="mt-4 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm"
                                    >
                                        â¸ï¸ å­¦ç¿’ã‚’ä¸­æ–­
                                    </button>
                                )}
                            </div>
                        </div>
                    );
                }

                // å„ªå…ˆé †ä½3: å­¦ç¿’ä¸­ã§å•é¡ŒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆï¼ˆå¾…æ©ŸçŠ¶æ…‹ï¼‰
                if (studyMode === 'studying' && !mathCurrentProblem && !mathIsLoading) {
                    console.log('ğŸ” ãƒ‡ãƒãƒƒã‚° - å•é¡Œå¾…æ©ŸçŠ¶æ…‹:', {
                        studyMode,
                        mathCurrentProblem: !!mathCurrentProblem,
                        mathIsLoading,
                        studySettings
                    });
                    
                    return (
                        <div className="flex items-center justify-center min-h-64 p-4">
                            <div className="text-center max-w-sm mx-auto">
                                <div className="text-4xl sm:text-6xl mb-4">
                                    â³
                                </div>
                                <div className="text-lg sm:text-xl font-bold text-blue-600 mb-2">
                                    å•é¡Œã‚’æº–å‚™ä¸­<span className="loading-dots"></span>
                                </div>
                                <div className="text-xs sm:text-sm text-gray-600 mb-4">
                                    è¨­å®šã«åŸºã¥ã„ã¦å•é¡Œã‚’å–å¾—ã—ã¦ã„ã¾ã™
                                </div>
                                <div className="mt-2 text-xs text-gray-500">
                                    ãƒ‡ãƒãƒƒã‚°: studyMode={studyMode}, mathCurrentProblem={mathCurrentProblem ? 'ã‚ã‚Š' : 'ãªã—'}, loading={mathIsLoading ? 'true' : 'false'}
                                </div>
                                <button
                                    onClick={backToSetup}
                                    className="mt-4 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm"
                                >
                                    âš™ï¸ è¨­å®šã«æˆ»ã‚‹
                                </button>
                                <button
                                    onClick={() => getNextProblem()}
                                    className="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
                                >
                                    ğŸ”„ å•é¡Œå–å¾—ã‚’å†è©¦è¡Œ
                                </button>
                            </div>
                        </div>
                    );
                }


                // å­¦ç¿’ä¸­ã§å•é¡ŒãŒãªã„å ´åˆï¼ˆã‚¨ãƒ©ãƒ¼å¯¾å‡¦ï¼‰
                if (studyMode === 'studying' && !mathCurrentProblem) {
                    return (
                        <div className="space-y-4">
                            {/* å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ± */}
                            {studySettings && (
                                <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg">
                                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                        <div>
                                            <h2 className="text-lg font-bold">ğŸ¯ å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­</h2>
                                            <p className="text-sm opacity-90">
                                                {studySettings.grade} | {studySettings.unit} | {studySettings.level}ãƒ¬ãƒ™ãƒ«
                                            </p>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="text-center">
                                                <div className="text-xl font-bold">{problemCount - 1}</div>
                                                <div className="text-xs opacity-80">å•é¡Œç›®</div>
                                            </div>
                                            <button
                                                onClick={backToSetup}
                                                className="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm font-medium transition-all"
                                            >
                                                âš™ï¸ è¨­å®šå¤‰æ›´
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center">
                                <h3 className="font-bold text-yellow-800 mb-2">âš ï¸ å•é¡Œå–å¾—ã‚¨ãƒ©ãƒ¼</h3>
                                <p className="text-yellow-700 mb-4">å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã™ã‚‹ã‹è¨­å®šã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
                                <div className="flex flex-col sm:flex-row gap-2 justify-center">
                                    <button
                                        onClick={() => getNextProblem()}
                                        className="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
                                    >
                                        ğŸ”„ å†è©¦è¡Œ
                                    </button>
                                    <button
                                        onClick={backToSetup}
                                        className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
                                    >
                                        âš™ï¸ è¨­å®šã‚’å¤‰æ›´
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                // è¨­å®šãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                if (studyMode === 'setup') {
                    return (
                        <div className="space-y-6">
                            {/* å­¦ç¿’è¨­å®šãƒ˜ãƒƒãƒ€ãƒ¼ */}
                            <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 sm:p-6 rounded-lg">
                                <h2 className="text-xl sm:text-2xl font-bold mb-2">ğŸ¯ å­¦ç¿’è¨­å®š</h2>
                                <p className="text-sm sm:text-base opacity-90">å­¦å¹´ãƒ»åˆ†é‡ãƒ»é›£æ˜“åº¦ã‚’é¸æŠã—ã¦å­¦ç¿’ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†</p>
                            </div>

                            {/* å•é¡Œå–å¾—æ–¹æ³•é¸æŠ */}
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow border">
                                <h4 className="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                                    ğŸ“š å•é¡Œå–å¾—æ–¹æ³•
                                </h4>
                                
                                {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */}
                                <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                    <button
                                        onClick={() => setUsePool(true)}
                                        className={`flex-1 p-3 rounded-lg text-sm font-medium transition-all ${
                                            usePool 
                                                ? 'bg-blue-600 text-white shadow-md' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        ğŸ“š å•é¡Œãƒ—ãƒ¼ãƒ«ã‹ã‚‰å–å¾— 
                                        {problemPoolStats && (
                                            <span className="block text-xs mt-1 opacity-80">
                                                {problemPoolStats.total_problems}å•é¡Œåˆ©ç”¨å¯èƒ½
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => setUsePool(false)}
                                        className={`flex-1 p-3 rounded-lg text-sm font-medium transition-all ${
                                            !usePool 
                                                ? 'bg-green-600 text-white shadow-md' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        ğŸ¤– AIæ–°è¦ç”Ÿæˆ
                                        <span className="block text-xs mt-1 opacity-80">
                                            {apiStatus.connected ? 'åˆ©ç”¨å¯èƒ½' : 'æ¥ç¶šã‚¨ãƒ©ãƒ¼'}
                                        </span>
                                    </button>
                                </div>

                                {/* å•é¡Œãƒ—ãƒ¼ãƒ«çµ±è¨ˆæƒ…å ± */}
                                {usePool && problemPoolStats && (
                                    <div className="bg-blue-50 p-3 rounded-lg mb-4">
                                        <h5 className="font-semibold text-blue-900 mb-2 text-sm">ğŸ“Š ãƒ—ãƒ¼ãƒ«çµ±è¨ˆ</h5>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
                                            <div className="text-center">
                                                <div className="font-bold text-blue-700">{problemPoolStats.total_problems}</div>
                                                <div className="text-blue-600">ç·å•é¡Œæ•°</div>
                                            </div>
                                            {Object.entries(problemPoolStats.problems_by_level || {}).map(([level, count]) => (
                                                <div key={level} className="text-center">
                                                    <div className="font-bold text-blue-700">{count}</div>
                                                    <div className="text-blue-600">{level}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªè¨­å®šã‚°ãƒªãƒƒãƒ‰ */}
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">å­¦å¹´</label>
                                        <select
                                            value={selectedGrade}
                                            onChange={(e) => setSelectedGrade(e.target.value)}
                                            className="w-full p-2 sm:p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                                        >
                                            {gradeOptions.map(grade => (
                                                <option key={grade} value={grade}>{grade}</option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">åˆ†é‡</label>
                                        <select
                                            value={selectedUnit}
                                            onChange={(e) => setSelectedUnit(e.target.value)}
                                            className="w-full p-2 sm:p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                                        >
                                            {unitsByGrade[selectedGrade].map(unit => (
                                                <option key={unit} value={unit}>{unit}</option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">é›£æ˜“åº¦</label>
                                        <select
                                            value={selectedLevel}
                                            onChange={(e) => setSelectedLevel(e.target.value)}
                                            className="w-full p-2 sm:p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                                        >
                                            {levelOptions.map(level => (
                                                <option key={level.value} value={level.value}>
                                                    <span className="sm:hidden">{level.value}</span>
                                                    <span className="hidden sm:inline">{level.value} - {level.description}</span>
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                
                                {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */}
                                <div className="flex flex-wrap items-center gap-2 text-xs">
                                    <div className="flex items-center gap-1">
                                        <div className={`w-2 h-2 rounded-full ${apiStatus.connected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                        <span className="text-gray-600">
                                            AI: {apiStatus.checking ? '...' : (apiStatus.connected ? 'OK' : 'NG')}
                                        </span>
                                    </div>
                                    {problemPoolStats && (
                                        <div className="flex items-center gap-1">
                                            <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                            <span className="text-gray-600">
                                                ãƒ—ãƒ¼ãƒ«: {problemPoolStats.total_problems}å•é¡Œ
                                            </span>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªå•é¡Œå–å¾—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                            <div className="text-center bg-gradient-to-r from-blue-50 to-purple-50 p-4 sm:p-8 rounded-lg">
                                <div className="text-4xl sm:text-6xl mb-4">
                                    {usePool ? 'ğŸ“š' : 'ğŸ¤–'}
                                </div>
                                <h3 className="text-lg sm:text-2xl font-bold text-gray-800 mb-2 sm:mb-4">
                                    {usePool ? 'å•é¡Œãƒ—ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ' : 'AIå•é¡Œç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ '}
                                </h3>
                                <p className="text-sm sm:text-base text-gray-600 mb-4 sm:mb-6">
                                    è¨­å®š: {selectedGrade} | {selectedUnit} | {selectedLevel}ãƒ¬ãƒ™ãƒ«
                                </p>
                                
                                {/* å­¦ç¿’é–‹å§‹ãƒœã‚¿ãƒ³ */}
                                <button
                                    onClick={() => {
                                        console.log('ğŸ–±ï¸ [ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯] å­¦ç¿’é–‹å§‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                                        console.log('ğŸ” [ãƒœã‚¿ãƒ³çŠ¶æ…‹] usePool:', usePool, 'apiStatus.connected:', apiStatus.connected);
                                        console.log('ğŸ” [ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–] disabledçŠ¶æ…‹:', !usePool && !apiStatus.connected);
                                        startStudySession();
                                    }}
                                    disabled={!usePool && !apiStatus.connected}
                                    className={`w-full px-8 py-4 rounded-lg text-lg font-bold transition-all transform hover:scale-105 active:scale-95 touch-manipulation ${
                                        (usePool || (!usePool && apiStatus.connected))
                                            ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:from-blue-700 hover:to-purple-700 shadow-lg'
                                            : 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                    }`}
                                >
                                    ğŸš€ å­¦ç¿’é–‹å§‹
                                    <span className="block text-sm font-normal mt-1 opacity-80">
                                        {usePool ? `ğŸ“š ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ç¶™ç¶šå‡ºé¡Œ` : `ğŸ¤– AIæ–°è¦ç”Ÿæˆã§ç¶™ç¶šå‡ºé¡Œ`}
                                    </span>
                                </button>
                                
                                <p className="text-xs sm:text-sm text-gray-500 mt-3 sm:mt-4">
                                    {usePool ? (
                                        problemPoolStats ? (
                                            `${problemPoolStats.total_problems}å•é¡Œã‹ã‚‰å³åº§ã«å–å¾—ã—ã¾ã™`
                                        ) : (
                                            'å•é¡Œãƒ—ãƒ¼ãƒ«ã‹ã‚‰ç¬æ™‚ã«å•é¡Œã‚’å–å¾—'
                                        )
                                    ) : (
                                        apiStatus.connected 
                                            ? 'ç´„3-5ç§’ã§é«˜å“è³ªãªå•é¡Œã¨è©³ç´°è§£èª¬ã‚’ç”Ÿæˆ'
                                            : 'ã‚µãƒ¼ãƒãƒ¼ã®APIã‚­ãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„'
                                    )}
                                </p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="space-y-4 sm:space-y-6">
                        {/* å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ± */}
                        {studySettings && (
                            <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg">
                                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                    <div>
                                        <h2 className="text-lg font-bold">ğŸ¯ å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­</h2>
                                        <p className="text-sm opacity-90">
                                            {studySettings.grade} | {studySettings.unit} | {studySettings.level}ãƒ¬ãƒ™ãƒ«
                                        </p>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="text-center">
                                            <div className="text-xl font-bold">{problemCount - 1}</div>
                                            <div className="text-xs opacity-80">å•é¡Œç›®</div>
                                        </div>
                                        <button
                                            onClick={backToSetup}
                                            className="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm font-medium transition-all"
                                        >
                                            âš™ï¸ è¨­å®šå¤‰æ›´
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* å•é¡Œè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆmathCurrentProblemã‚’ä½¿ç”¨ï¼‰ */}
                        <div className="bg-blue-50 p-4 sm:p-6 rounded-lg">
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-4 mb-4">
                                <h3 className="text-lg sm:text-xl font-bold text-blue-900">
                                    {mathCurrentProblem.source === 'pool' ? 'ğŸ“š' : 'ğŸ¤–'} {mathCurrentProblem.source === 'pool' ? 'ãƒ—ãƒ¼ãƒ«å•é¡Œ' : 'AIç”Ÿæˆå•é¡Œ'} - {mathCurrentProblem.grade} {mathCurrentProblem.unit}
                                </h3>
                                <span className={`self-start sm:self-auto px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium ${
                                    mathCurrentProblem.level === 'åŸºç¤' ? 'bg-green-200 text-green-800' :
                                    mathCurrentProblem.level === 'æ¨™æº–' ? 'bg-blue-200 text-blue-800' :
                                    mathCurrentProblem.level === 'å¿œç”¨' ? 'bg-orange-200 text-orange-800' :
                                    'bg-red-200 text-red-800'
                                }`}>
                                    {mathCurrentProblem.level}ãƒ¬ãƒ™ãƒ«
                                </span>
                            </div>
                            
                            <div className="bg-white p-4 sm:p-6 rounded border-l-4 border-blue-500">
                                <p className="text-base sm:text-lg font-medium mb-4 whitespace-pre-wrap leading-relaxed">{mathCurrentProblem.problem}</p>
                                {mathCurrentProblem.hint && (
                                    <div className="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400">
                                        <p className="text-sm text-yellow-800">
                                            ğŸ’¡ <strong>ãƒ’ãƒ³ãƒˆ:</strong> {mathCurrentProblem.hint}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div>
                            {console.log('ğŸ” [JSXæ¡ä»¶] showStepså€¤:', showSteps)}
                            {!showSteps ? (
                                <div className="flex flex-col sm:flex-row gap-3 sm:gap-4">
                                    <button
                                        onClick={() => {
                                            console.log('ğŸ” [è§£èª¬ãƒœã‚¿ãƒ³] è§£èª¬ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                                            console.log('ğŸ” [å•é¡Œãƒ‡ãƒ¼ã‚¿] mathCurrentProblem:', mathCurrentProblem);
                                            console.log('ğŸ” [ã‚¹ãƒ†ãƒƒãƒ—ç¢ºèª] stepså­˜åœ¨:', !!mathCurrentProblem.steps);
                                            console.log('ğŸ” [ã‚¹ãƒ†ãƒƒãƒ—æ•°] steps.length:', mathCurrentProblem.steps?.length);
                                            if (mathCurrentProblem.steps) {
                                                console.log('ğŸ” [ã‚¹ãƒ†ãƒƒãƒ—å†…å®¹] æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—:', mathCurrentProblem.steps[0]);
                                            }
                                            setShowSteps(true);
                                        }}
                                        className="bg-blue-600 text-white px-4 sm:px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 flex items-center justify-center gap-2 touch-manipulation font-medium"
                                    >
                                        ğŸ§  <span className="sm:hidden">è§£èª¬ã‚’è¦‹ã‚‹</span><span className="hidden sm:inline">{mathCurrentProblem.steps && mathCurrentProblem.steps.length > 0 ? 'AIè©³ç´°è§£èª¬ã‚’è¦‹ã‚‹' : 'è§£ç­”ã‚’è¦‹ã‚‹'}</span>
                                    </button>
                                    <button
                                        onClick={() => getNextProblem()}
                                        className="bg-green-600 text-white px-4 sm:px-6 py-3 rounded-lg hover:bg-green-700 active:bg-green-800 touch-manipulation font-medium"
                                    >
                                        ğŸ”„ <span className="sm:hidden">æ¬¡ã®å•é¡Œ</span><span className="hidden sm:inline">æ¬¡ã®å•é¡Œã‚’{studySettings?.usePool ? 'å–å¾—' : 'ç”Ÿæˆ'}</span>
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {console.log('ğŸ” [JSX] è§£èª¬è¡¨ç¤ºãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠ')}
                                    {/* çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è§£èª¬ç”»é¢ */}
                                    <div className="bg-gray-50 p-4 sm:p-6 rounded-lg">
                                        <h4 className="font-bold text-base sm:text-lg mb-4">
                                            {mathCurrentProblem.source === 'pool' ? 'ğŸ“š ãƒ—ãƒ¼ãƒ«å•é¡Œï¼š' : 'ğŸ¤– AIç”Ÿæˆï¼š'}è©³ç´°è§£èª¬
                                            {mathCurrentProblem.steps && mathCurrentProblem.steps.length > 0 && `ï¼ˆ${mathCurrentProblem.steps.length}æ®µéšï¼‰`}
                                        </h4>
                                        
                                        {mathCurrentProblem.steps && mathCurrentProblem.steps.length > 0 ? (
                                            /* è©³ç´°ã‚¹ãƒ†ãƒƒãƒ—è§£èª¬ãŒã‚ã‚‹å ´åˆ */
                                            <>
                                                {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªã‚¹ãƒ†ãƒƒãƒ—é¸æŠ */}
                                                <div className="grid grid-cols-2 sm:flex gap-2 mb-4 sm:mb-6">
                                                    {mathCurrentProblem.steps.map((step, idx) => {
                                                        const stepLabels = [
                                                            'ç†è§£', 'æ–¹é‡', 'æº–å‚™', 'è¨ˆç®—', 'æ¨è«–', 'æ¤œç®—', 'ã¾ã¨ã‚'
                                                        ];
                                                        return (
                                                            <button
                                                                key={idx}
                                                                onClick={() => setCurrentStep(idx)}
                                                                className={`px-2 sm:px-4 py-2 rounded text-xs sm:text-sm font-medium transition-all touch-manipulation ${
                                                                    currentStep === idx
                                                                        ? 'bg-blue-600 text-white shadow-md'
                                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300 active:bg-gray-400'
                                                                }`}
                                                                title={step.step}
                                                            >
                                                                <span className="sm:hidden">{idx + 1}</span>
                                                                <span className="hidden sm:inline">{idx + 1}. {stepLabels[idx] || `ã‚¹ãƒ†ãƒƒãƒ—${idx + 1}`}</span>
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                                
                                                <div className="bg-white p-4 sm:p-6 rounded border step-animation">
                                                    <h5 className="font-bold text-blue-900 mb-3 text-base sm:text-lg">
                                                        {currentStep + 1}. {mathCurrentProblem.steps[currentStep].step}
                                                    </h5>
                                                    
                                                    <div className="space-y-3 sm:space-y-4">
                                                        <div>
                                                            <h6 className="font-semibold text-gray-800 mb-2 text-sm">ğŸ“ å†…å®¹</h6>
                                                            <p className="text-gray-800 bg-gray-50 p-3 rounded text-sm sm:text-base whitespace-pre-wrap leading-relaxed">
                                                                {mathCurrentProblem.steps[currentStep].content}
                                                            </p>
                                                        </div>
                                                        
                                                        <div>
                                                            <h6 className="font-semibold text-gray-800 mb-2 text-sm">ğŸ’¡ è§£èª¬</h6>
                                                            <p className="text-yellow-800 bg-yellow-50 p-3 rounded text-sm sm:text-base whitespace-pre-wrap leading-relaxed">
                                                                {mathCurrentProblem.steps[currentStep].explanation}
                                                            </p>
                                                        </div>
                                                        
                                                        {mathCurrentProblem.steps[currentStep].detail && (
                                                            <div>
                                                                <h6 className="font-semibold text-gray-800 mb-2 text-sm">ğŸ” è©³ç´°</h6>
                                                                <p className="text-blue-800 bg-blue-50 p-3 rounded text-sm sm:text-base whitespace-pre-wrap leading-relaxed">
                                                                    {mathCurrentProblem.steps[currentStep].detail}
                                                                </p>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
                                                <div className="flex gap-2 mt-4 sm:mt-6">
                                                    <button
                                                        onClick={() => setCurrentStep(Math.max(0, currentStep - 1))}
                                                        disabled={currentStep === 0}
                                                        className="flex-1 sm:flex-initial px-3 sm:px-4 py-2 bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation font-medium text-sm"
                                                    >
                                                        â¬…ï¸ <span className="sm:hidden">å‰</span><span className="hidden sm:inline">å‰ã®ã‚¹ãƒ†ãƒƒãƒ—</span>
                                                    </button>
                                                    <button
                                                        onClick={() => setCurrentStep(Math.min(mathCurrentProblem.steps.length - 1, currentStep + 1))}
                                                        disabled={currentStep === mathCurrentProblem.steps.length - 1}
                                                        className="flex-1 sm:flex-initial px-3 sm:px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation font-medium text-sm"
                                                    >
                                                        <span className="sm:hidden">æ¬¡</span><span className="hidden sm:inline">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</span> â¡ï¸
                                                    </button>
                                                </div>
                                            </>
                                        ) : (
                                            /* è©³ç´°è§£èª¬ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ */
                                            <div className="bg-orange-50 border border-orange-200 p-4 sm:p-6 rounded-lg">
                                                <div className="flex items-start gap-3 mb-4">
                                                    <div className="text-orange-500 text-xl">âš ï¸</div>
                                                    <div className="flex-1">
                                                        <h5 className="font-bold text-orange-900 mb-2">è©³ç´°è§£èª¬ãƒ‡ãƒ¼ã‚¿ãªã—</h5>
                                                        <p className="text-orange-800 text-sm mb-3">
                                                            ã“ã®å•é¡Œã«ã¯æ®µéšçš„ãªè©³ç´°è§£èª¬ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                                                            åŸºæœ¬çš„ãªè§£ç­”æƒ…å ±ã®ã¿è¡¨ç¤ºã—ã¾ã™ã€‚
                                                        </p>
                                                    </div>
                                                </div>
                                                
                                                {/* åŸºæœ¬çš„ãªè§£ç­”æƒ…å ± */}
                                                <div className="bg-green-50 p-3 sm:p-4 rounded-lg mb-4">
                                                    <h4 className="font-bold text-green-900 mb-2 text-sm sm:text-base">âœ… è§£ç­”</h4>
                                                    <p className="text-green-800 text-base sm:text-lg font-medium whitespace-pre-wrap">{mathCurrentProblem.answer}</p>
                                                </div>
                                                
                                                {mathCurrentProblem.hint && (
                                                    <div className="bg-yellow-50 p-3 sm:p-4 rounded-lg mb-4">
                                                        <h4 className="font-bold text-yellow-900 mb-2 text-sm sm:text-base">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h4>
                                                        <p className="text-yellow-800 text-sm sm:text-base leading-relaxed">{mathCurrentProblem.hint}</p>
                                                    </div>
                                                )}
                                                
                                                <div className="bg-blue-50 p-3 rounded text-sm text-blue-800">
                                                    <p>ğŸ’¡ <strong>ã‚ˆã‚Šè©³ç´°ãªè§£èª¬ãŒå¿…è¦ãªå ´åˆã¯ï¼š</strong></p>
                                                    <p>è¨­å®šç”»é¢ã§ã€ŒAIæ–°è¦ç”Ÿæˆã€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€æ®µéšçš„ãªè©³ç´°è§£èª¬ä»˜ãã®å•é¡ŒãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* è§£ç­”ã¨å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆï¼ˆAIç”Ÿæˆå•é¡Œã®ã¿ï¼‰ */}
                                    {mathCurrentProblem.steps && mathCurrentProblem.steps.length > 0 && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                                            <div className="bg-green-50 p-3 sm:p-4 rounded-lg">
                                                <h4 className="font-bold text-green-900 mb-2 text-sm sm:text-base">âœ… è§£ç­”</h4>
                                                <p className="text-green-800 text-base sm:text-lg font-medium whitespace-pre-wrap">{mathCurrentProblem.answer}</p>
                                            </div>
                                            
                                            {mathCurrentProblem.learning_point && (
                                                <div className="bg-purple-50 p-3 sm:p-4 rounded-lg">
                                                    <h4 className="font-bold text-purple-900 mb-2 text-sm sm:text-base">ğŸ“š å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</h4>
                                                    <p className="text-purple-800 text-xs sm:text-sm leading-relaxed">{mathCurrentProblem.learning_point}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="flex flex-col sm:flex-row gap-3 sm:gap-4">
                                        <button
                                            onClick={() => {
                                                setShowSteps(false);
                                                setCurrentStep(0);
                                            }}
                                            className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 active:bg-gray-800 touch-manipulation font-medium text-sm"
                                        >
                                            ğŸ“‹ å•é¡Œã«æˆ»ã‚‹
                                        </button>
                                        <button
                                            onClick={() => getNextProblem()}
                                            className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 active:bg-green-800 touch-manipulation font-medium text-sm"
                                        >
                                            ğŸ”„ æ¬¡ã®å•é¡Œã‚’{studySettings?.usePool ? 'å–å¾—' : 'ç”Ÿæˆ'}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };



            // è‹±å˜èªå­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const EnglishWordSection = () => {
                const [selectedGrade, setSelectedGrade] = useState('ä¸­2');
                const [selectedLevel, setSelectedLevel] = useState('æ¨™æº–');
                
                const generateEnglishWord = async (grade, level) => {
                    setIsLoading(true);
                    setCurrentWord(null); // è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
                    const prompt = `
ã‚«ãƒªã‚¿ã‚¹ä¸­å­¦æ ¡ã®Progress 21ã«æº–æ‹ ã—ãŸè‹±å˜èªã‚’1ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚

è¨­å®š:
- å­¦å¹´: ${grade}
- ãƒ¬ãƒ™ãƒ«: ${level}

ä»¥ä¸‹ã®JSONå½¢å¼ã§ã€å¿…ãšå…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚ã¦å›ç­”ã—ã¦ãã ã•ã„:
{
  "word": "è‹±å˜èª",
  "meaning": "æ—¥æœ¬èªã®æ„å‘³",
  "pronunciation": "ç™ºéŸ³è¨˜å·",
  "level": "${level}",
  "etymology": "èªæºã‚„æˆã‚Šç«‹ã¡ã®ç°¡å˜ãªè§£èª¬",
  "examples": [
    { "sentence": "ä¾‹æ–‡1", "translation": "ãã®å’Œè¨³" },
    { "sentence": "ä¾‹æ–‡2", "translation": "ãã®å’Œè¨³" }
  ],
  "synonyms": ["é¡ç¾©èª1", "é¡ç¾©èª2"]
}

DO NOT OUTPUT ANYTHING OTHER THAN VALID JSON.
                    `;

                    const API_URL = window.CARITAS_API_URL;
                    try {
                        const response = await fetch(`${API_URL}/api/generate-english`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt })
                        });
                        if (!response.ok) throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        const data = await response.json();
                        if (!data.success) throw new Error(data.error);
                        
                        const wordData = JSON.parse(data.result);
                        setCurrentWord(wordData);
                        setEnglishProgress(prev => ({ ...prev, words: prev.words + 1 }));

                    } catch (error) {
                        console.error('AIè‹±å˜èªç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                        showAlert('è‹±å˜èªç”Ÿæˆã‚¨ãƒ©ãƒ¼', `AIè‹±å˜èªç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n${error.message}\n\nAPIæ¥ç¶šçŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    } finally {
                        setIsLoading(false);
                    }
                };

                if (isLoading) {
                    return (
                        <div className="flex items-center justify-center h-64">
                            <div className="text-center">
                                <div className="text-4xl mb-4 pulse-animation">ğŸ“š</div>
                                <div className="text-xl font-bold text-green-600 mb-2">
                                    AIãŒæœ€é©ãªè‹±å˜èªã‚’ç”Ÿæˆä¸­<span className="loading-dots"></span>
                                </div>
                            </div>
                        </div>
                    );
                }

                if (!currentWord) {
                    return (
                        <div>
                            <div className="bg-white p-6 rounded-lg shadow border mb-6">
                                <h4 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    ğŸ“š AIè‹±å˜èªç”Ÿæˆè¨­å®š
                                </h4>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">å­¦å¹´</label>
                                        <select
                                            value={selectedGrade}
                                            onChange={(e) => setSelectedGrade(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500"
                                        >
                                            <option value="ä¸­1">ä¸­1</option>
                                            <option value="ä¸­2">ä¸­2</option>
                                            <option value="ä¸­3">ä¸­3</option>
                                            <option value="é«˜1">é«˜1</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">ãƒ¬ãƒ™ãƒ«</label>
                                        <select
                                            value={selectedLevel}
                                            onChange={(e) => setSelectedLevel(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500"
                                        >
                                            <option value="åŸºæœ¬">åŸºæœ¬</option>
                                            <option value="æ¨™æº–">æ¨™æº–</option>
                                            <option value="ç™ºå±•">ç™ºå±•</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div className="text-center">
                                <button
                                    onClick={() => generateEnglishWord(selectedGrade, selectedLevel)}
                                    disabled={!apiStatus.connected}
                                    className={`px-8 py-4 rounded-lg text-lg font-medium transition-all transform hover:scale-105 ${
                                        apiStatus.connected 
                                            ? 'bg-green-600 text-white hover:bg-green-700' 
                                            : 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                    }`}
                                >
                                    {apiStatus.connected ? 'ğŸŒ± æ–°ã—ã„å˜èªã‚’å­¦ç¿’' : 'âŒ AIæ¥ç¶šãŒå¿…è¦ã§ã™'}
                                </button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="space-y-6">
                        <div className="bg-white p-8 rounded-lg shadow-lg border-l-4 border-green-500">
                            <h3 className="text-4xl font-bold text-gray-800 mb-2">{currentWord.word}</h3>
                            <p className="text-lg text-gray-600 mb-4">{currentWord.pronunciation}</p>
                            <p className="text-xl font-semibold text-green-700">{currentWord.meaning}</p>
                        </div>

                        <div className="bg-green-50 p-6 rounded-lg">
                            <h4 className="font-bold text-green-900 mb-3">ä¾‹æ–‡</h4>
                            <ul className="space-y-3">
                                {currentWord.examples.map((ex, i) => (
                                    <li key={i}>
                                        <p className="font-medium text-gray-800">{ex.sentence}</p>
                                        <p className="text-sm text-gray-600">{ex.translation}</p>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            <div className="bg-blue-50 p-6 rounded-lg">
                                <h4 className="font-bold text-blue-900 mb-3">èªæº</h4>
                                <p className="text-sm text-blue-800">{currentWord.etymology}</p>
                            </div>
                            <div className="bg-purple-50 p-6 rounded-lg">
                                <h4 className="font-bold text-purple-900 mb-3">é¡ç¾©èª</h4>
                                <div className="flex flex-wrap gap-2">
                                    {currentWord.synonyms.map(s => (
                                        <span key={s} className="bg-purple-200 text-purple-800 px-3 py-1 rounded-full text-sm">
                                            {s}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="text-center mt-8">
                            <button
                                onClick={() => generateEnglishWord(selectedGrade, selectedLevel)}
                                className="bg-green-600 text-white px-8 py-4 rounded-lg text-lg font-medium"
                            >
                                ğŸ”„ æ¬¡ã®å˜èªã¸
                            </button>
                        </div>
                    </div>
                );
            };


            // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å…¨ä½“ã«çµ±åˆ
            return (
                <>
                    {currentSection === 'menu' && (
                        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 p-3 sm:p-4">
                            <div className="max-w-4xl mx-auto">
                                <div className="text-center mb-6 sm:mb-8">
                                    <div className="text-4xl sm:text-6xl mb-3 sm:mb-4">ğŸ¤–</div>
                                    <h1 className="text-xl sm:text-3xl font-bold text-gray-800 mb-2">
                                        ã‚«ãƒªã‚¿ã‚¹ä¸­å­¦æ ¡ AIå­¦ç¿’ãƒ„ãƒ¼ãƒ«
                                    </h1>
                                    <h2 className="text-lg sm:text-xl font-semibold text-purple-700 mb-2">
                                        å®Œå…¨AIæ­è¼‰ç‰ˆ
                                    </h2>
                                    <p className="text-sm sm:text-base text-gray-600">ä½“ç³»æ•°å­¦ãƒ»Progress 21æº–æ‹  + æœ¬æ ¼AIå•é¡Œç”Ÿæˆ</p>
                                    <div className="mt-3 sm:mt-4 flex flex-wrap justify-center gap-1 sm:gap-2 text-xs sm:text-sm">
                                        <span className="bg-purple-100 text-purple-800 px-2 sm:px-3 py-1 rounded-full">
                                            ğŸ¤– OpenAI
                                        </span>
                                        <span className="bg-blue-100 text-blue-800 px-2 sm:px-3 py-1 rounded-full">
                                            ğŸ“ è©³ç´°è§£èª¬
                                        </span>
                                        <span className="bg-green-100 text-green-800 px-2 sm:px-3 py-1 rounded-full">
                                            ğŸ¯ å®Œå…¨æº–æ‹ 
                                        </span>
                                    </div>
                                </div>

                                {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªAPIçŠ¶æ…‹è¡¨ç¤º */}
                                <div className="bg-white p-3 sm:p-4 rounded-lg shadow mb-4 sm:mb-6">
                                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-2 sm:w-3 h-2 sm:h-3 rounded-full ${apiStatus.connected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                            <span className="text-xs sm:text-sm font-medium">
                                                AIçŠ¶æ…‹: {apiStatus.checking ? 'ãƒã‚§ãƒƒã‚¯ä¸­...' : (apiStatus.connected ? 'æ¥ç¶šæ¸ˆã¿' : 'æ¥ç¶šã‚¨ãƒ©ãƒ¼')}
                                                {apiStatus.browser && ` (${apiStatus.browser})`}
                                            </span>
                                        </div>
                                        {apiStatus.version && (
                                            <span className="text-xs text-gray-500">v{apiStatus.version}</span>
                                        )}
                                    </div>
                                    {apiStatus.apiUrl && (
                                        <div className="text-xs text-gray-500 mt-1 truncate">
                                            æ¥ç¶šURL: {apiStatus.apiUrl}
                                        </div>
                                    )}
                                    {/* å•é¡Œãƒ—ãƒ¼ãƒ«çµ±è¨ˆã‚‚è¡¨ç¤º */}
                                    {problemPoolStats && (
                                        <div className="text-xs text-blue-600 mt-1">
                                            å•é¡Œãƒ—ãƒ¼ãƒ«: {problemPoolStats.total_problems}å•é¡Œåˆ©ç”¨å¯èƒ½
                                        </div>
                                    )}
                                </div>

                                {/* Safariæ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®ç‰¹åˆ¥ãªæ¡ˆå†… */}
                                {!apiStatus.connected && apiStatus.browser === 'Safari' && (
                                    <div className="bg-orange-50 border border-orange-200 p-4 rounded-lg mb-6">
                                        <div className="flex items-start gap-3">
                                            <div className="text-orange-500 text-xl">âš ï¸</div>
                                            <div>
                                                <h4 className="font-bold text-orange-800 mb-2">Safariæ¥ç¶šã‚¨ãƒ©ãƒ¼</h4>
                                                <p className="text-orange-700 text-sm mb-3">
                                                    Safari ã®å³æ ¼ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã«ã‚ˆã‚Šã€localhost ã¸ã®æ¥ç¶šãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚
                                                </p>
                                                <div className="text-orange-700 text-sm space-y-2">
                                                    <p><strong>è§£æ±ºæ–¹æ³•ï¼š</strong></p>
                                                    <ol className="list-decimal list-inside space-y-1 ml-4">
                                                        <li>Safari &gt; é–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ &gt; ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã§ä¿è­·ã•ã‚Œã¦ã„ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹</li>
                                                        <li>Chromeã€Firefoxã€Edge ãªã©ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼ˆæ¨å¥¨ï¼‰</li>
                                                    </ol>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                                    {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªæ•°å­¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                                    <div 
                                        onClick={() => {
                                            setSelectedSubject('math');
                                            setCurrentSection('study');
                                        }}
                                        className="bg-white p-4 sm:p-6 rounded-lg shadow-lg hover:shadow-xl transition-all cursor-pointer border-l-4 border-blue-500 touch-manipulation active:scale-95"
                                    >
                                        <div className="flex items-center gap-3 sm:gap-4 mb-3 sm:mb-4">
                                            <div className="bg-blue-100 p-2 sm:p-3 rounded-lg text-2xl sm:text-3xl">ğŸ§®</div>
                                            <div className="min-w-0 flex-1">
                                                <h2 className="text-lg sm:text-xl font-bold text-gray-800">æ•°å­¦ï¼ˆAI + ãƒ—ãƒ¼ãƒ«ï¼‰</h2>
                                                <p className="text-sm sm:text-base text-gray-600 truncate">ä½“ç³»æ•°å­¦æº–æ‹  + AIå•é¡Œç”Ÿæˆ</p>
                                            </div>
                                        </div>
                                        <ul className="text-xs sm:text-sm text-gray-700 space-y-1">
                                            <li>â€¢ ğŸ¤– <strong>AIå•é¡Œç”Ÿæˆ</strong>ï¼ˆæ€è€ƒåŠ›é‡è¦–ï¼‰</li>
                                            <li>â€¢ ğŸ“š <strong>å•é¡Œãƒ—ãƒ¼ãƒ«</strong>ï¼ˆå³åº§ã«å–å¾—ï¼‰</li>
                                            <li>â€¢ ğŸ“ <strong>è©³ç´°è§£èª¬</strong>ï¼ˆæ®µéšçš„èª¬æ˜ï¼‰</li>
                                            <li>â€¢ ğŸ¯ <strong>å®Œå…¨å¯¾å¿œ</strong>ï¼ˆå­¦å¹´ãƒ»åˆ†é‡ãƒ»é›£æ˜“åº¦ï¼‰</li>
                                        </ul>
                                        <div className="mt-3 sm:mt-4 flex items-center justify-between text-xs sm:text-sm">
                                            <span className="text-blue-600">è§£ç­”æ¸ˆã¿: {mathProgress.solved} å•é¡Œ</span>
                                            {problemPoolStats && (
                                                <span className="text-green-600">ãƒ—ãƒ¼ãƒ«: {problemPoolStats.total_problems}</span>
                                            )}
                                        </div>
                                    </div>

                                    {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªè‹±å˜èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                                    <div 
                                        onClick={() => {
                                            setSelectedSubject('english_word');
                                            setCurrentSection('study');
                                        }}
                                        className="bg-white p-4 sm:p-6 rounded-lg shadow-lg hover:shadow-xl transition-all cursor-pointer border-l-4 border-green-500 touch-manipulation active:scale-95"
                                    >
                                        <div className="flex items-center gap-3 sm:gap-4 mb-3 sm:mb-4">
                                            <div className="bg-green-100 p-2 sm:p-3 rounded-lg text-2xl sm:text-3xl">ğŸ“š</div>
                                            <div className="min-w-0 flex-1">
                                                <h2 className="text-lg sm:text-xl font-bold text-gray-800">AIè‹±å˜èªå­¦ç¿’</h2>
                                                <p className="text-sm sm:text-base text-gray-600 truncate">Progress 21æº–æ‹  + èªæºè§£èª¬</p>
                                            </div>
                                        </div>
                                        <ul className="text-xs sm:text-sm text-gray-700 space-y-1">
                                            <li>â€¢ ğŸ§  <strong>æ–‡è„ˆã§è¦šãˆã‚‹</strong>ä¾‹æ–‡è‡ªå‹•ç”Ÿæˆ</li>
                                            <li>â€¢ ğŸ—£ï¸ <strong>ç™ºéŸ³ãƒ»èªæº</strong>ã¾ã§å¾¹åº•è§£èª¬</li>
                                            <li>â€¢ ğŸ“ˆ <strong>ãƒ¬ãƒ™ãƒ«åˆ¥</strong>ã«åŠ¹ç‡ã‚ˆãå­¦ç¿’</li>
                                            <li>â€¢ ğŸ”„ <strong>å¿˜å´æ›²ç·š</strong>ã«åŸºã¥ã„ãŸå¾©ç¿’</li>
                                        </ul>
                                        <div className="mt-3 sm:mt-4 text-xs sm:text-sm text-green-600">
                                            å­¦ç¿’æ¸ˆã¿: {englishProgress.words} å˜èª
                                        </div>
                                    </div>

                                    {/* ç®¡ç†ç”»é¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                                    <div 
                                        onClick={() => setCurrentSection('admin')}
                                        className="bg-white p-4 sm:p-6 rounded-lg shadow-lg hover:shadow-xl transition-all cursor-pointer border-l-4 border-purple-500 touch-manipulation active:scale-95"
                                    >
                                        <div className="flex items-center gap-3 sm:gap-4 mb-3 sm:mb-4">
                                            <div className="bg-purple-100 p-2 sm:p-3 rounded-lg text-2xl sm:text-3xl">âš™ï¸</div>
                                            <div className="min-w-0 flex-1">
                                                <h2 className="text-lg sm:text-xl font-bold text-gray-800">å•é¡Œãƒ—ãƒ¼ãƒ«ç®¡ç†</h2>
                                                <p className="text-sm sm:text-base text-gray-600 truncate">AIå•é¡Œç”Ÿæˆ â†’ ãƒ—ãƒ¼ãƒ«è¿½åŠ </p>
                                            </div>
                                        </div>
                                        <ul className="text-xs sm:text-sm text-gray-700 space-y-1">
                                            <li>â€¢ ğŸ¤– <strong>AIå•é¡Œã‚’ä¸€æ‹¬ç”Ÿæˆ</strong>ï¼ˆ1ã€œ10å•ï¼‰</li>
                                            <li>â€¢ ğŸ“š <strong>ãƒ—ãƒ¼ãƒ«ã«ä¸€æ‹¬è¿½åŠ </strong>ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ï¼‰</li>
                                            <li>â€¢ ğŸ¯ <strong>å­¦å¹´ãƒ»åˆ†é‡ãƒ»é›£æ˜“åº¦</strong>ã‚’æŒ‡å®š</li>
                                            <li>â€¢ ğŸ“Š <strong>çµ±è¨ˆæƒ…å ±</strong>ã§ãƒ—ãƒ¼ãƒ«çŠ¶æ³ç¢ºèª</li>
                                        </ul>
                                        <div className="mt-3 sm:mt-4 text-xs sm:text-sm text-purple-600">
                                            ç®¡ç†è€…å‘ã‘æ©Ÿèƒ½ï¼ˆå•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ï¼‰
                                        </div>
                                    </div>
                                    
                                    {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªComing Soonã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                                    <div className="bg-gray-100 p-4 sm:p-6 rounded-lg shadow-inner cursor-not-allowed border-l-4 border-gray-300">
                                        <div className="flex items-center gap-3 sm:gap-4 mb-3 sm:mb-4 opacity-50">
                                            <div className="bg-gray-200 p-2 sm:p-3 rounded-lg text-2xl sm:text-3xl">ğŸ“</div>
                                            <div className="min-w-0 flex-1">
                                                <h2 className="text-lg sm:text-xl font-bold text-gray-500">AIè‹±èªå•é¡Œ</h2>
                                                <p className="text-sm sm:text-base text-gray-400 truncate">é•·æ–‡èª­è§£ãƒ»æ–‡æ³•ï¼ˆæº–å‚™ä¸­ï¼‰</p>
                                            </div>
                                        </div>
                                         <div className="text-center mt-3 sm:mt-4">
                                            <span className="bg-gray-300 text-gray-600 px-3 sm:px-4 py-1 sm:py-2 rounded-full text-xs sm:text-sm">
                                                Coming Soon
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªç‰¹å¾´èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                                <div className="bg-white p-4 sm:p-6 rounded-lg shadow-lg mt-6 sm:mt-8">
                                    <h3 className="text-base sm:text-lg font-bold text-gray-800 mb-3 sm:mb-4 text-center">
                                        ğŸ¤– AIå­¦ç¿’ãƒ„ãƒ¼ãƒ«ã®ç‰¹å¾´
                                    </h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 text-sm">
                                        <div className="bg-purple-50 p-3 sm:p-4 rounded-lg text-center">
                                            <div className="text-xl sm:text-2xl mb-2">ğŸ§ </div>
                                            <h4 className="font-bold text-purple-900 mb-1 text-sm">é«˜åº¦ãªå•é¡Œç”Ÿæˆ</h4>
                                            <p className="text-purple-700 text-xs sm:text-sm">æ€è€ƒåŠ›ã‚’è¦ã™ã‚‹è‰¯è³ªãªå•é¡Œ</p>
                                        </div>
                                        <div className="bg-blue-50 p-3 sm:p-4 rounded-lg text-center">
                                            <div className="text-xl sm:text-2xl mb-2">ğŸ“š</div>
                                            <h4 className="font-bold text-blue-900 mb-1 text-sm">å•é¡Œãƒ—ãƒ¼ãƒ« + AI</h4>
                                            <p className="text-blue-700 text-xs sm:text-sm">å³åº§ã«å–å¾— + ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ‰</p>
                                        </div>
                                        <div className="bg-green-50 p-3 sm:p-4 rounded-lg text-center">
                                            <div className="text-xl sm:text-2xl mb-2">ğŸ¯</div>
                                            <h4 className="font-bold text-green-900 mb-1 text-sm">å®Œå…¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h4>
                                            <p className="text-green-700 text-xs sm:text-sm">å€‹äººãƒ¬ãƒ™ãƒ«ã«æœ€é©åŒ–</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {currentSection === 'admin' && (
                        <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-3 sm:p-4">
                            <div className="max-w-6xl mx-auto">
                                {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªãƒ˜ãƒƒãƒ€ãƒ¼ */}
                                <div className="flex items-center gap-2 sm:gap-4 mb-4 sm:mb-6">
                                    <button
                                        onClick={() => setCurrentSection('menu')}
                                        className="bg-white p-2 sm:p-3 rounded-lg shadow hover:shadow-md transition-all touch-manipulation"
                                    >
                                        â†©ï¸
                                    </button>
                                    <h1 className="text-lg sm:text-2xl font-bold text-gray-800 min-w-0 flex-1">
                                        âš™ï¸ å•é¡Œãƒ—ãƒ¼ãƒ«ç®¡ç†ç”»é¢
                                    </h1>
                                    <div className="text-xs sm:text-sm text-purple-600 bg-purple-100 px-2 sm:px-3 py-1 rounded-full whitespace-nowrap">
                                        ç®¡ç†è€…æ©Ÿèƒ½
                                    </div>
                                </div>

                                <AdminSection />
                            </div>
                        </div>
                    )}

                    {currentSection === 'study' && (
                        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 p-3 sm:p-4">
                            <div className="max-w-4xl mx-auto">
                                {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªãƒ˜ãƒƒãƒ€ãƒ¼ */}
                                <div className="flex items-center gap-2 sm:gap-4 mb-4 sm:mb-6">
                                    <button
                                        onClick={() => setCurrentSection('menu')}
                                        className="bg-white p-2 sm:p-3 rounded-lg shadow hover:shadow-md transition-all touch-manipulation"
                                    >
                                        â†©ï¸
                                    </button>
                                    <h1 className="text-lg sm:text-2xl font-bold text-gray-800 min-w-0 flex-1">
                                        {selectedSubject === 'math' ? 'ğŸ¤– AIæ•°å­¦å­¦ç¿’' : 'ğŸ“š AIè‹±å˜èªå­¦ç¿’'}
                                    </h1>
                                    <div className="text-xs sm:text-sm text-purple-600 bg-purple-100 px-2 sm:px-3 py-1 rounded-full whitespace-nowrap">
                                        AI + ãƒ—ãƒ¼ãƒ«
                                    </div>
                                </div>

                                {selectedSubject === 'math' && <MathSection
                                    key="math-section"
                                    studyMode={mathStudyMode}
                                    setStudyMode={setMathStudyMode}
                                    studySettings={mathStudySettings}
                                    setStudySettings={setMathStudySettings}
                                    mathCurrentProblem={mathCurrentProblem}
                                    setMathCurrentProblem={setMathCurrentProblem}
                                    mathIsLoading={mathIsLoading}
                                    setMathIsLoading={setMathIsLoading}
                                    mathProgress={mathProgress}
                                    setMathProgress={setMathProgress}
                                    apiStatus={apiStatus}
                                    problemPoolStats={problemPoolStats}
                                    showAlert={showAlert}
                                    getProblemFromPool={getProblemFromPool}
                                    generateMathProblem={generateMathProblem}
                                />}
                                {selectedSubject === 'english_word' && <EnglishWordSection key="english-section" />}
                            </div>
                        </div>
                    )}

                    {/* ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° - å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å…±é€š */}
                    <ConfirmDialog 
                        show={showConfirmDialog} 
                        config={confirmConfig} 
                        onClose={() => setShowConfirmDialog(false)} 
                    />
                </>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<StudyTool />);
    </script>
</body>
</html>
